<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Android深入浅出之Binder机制 - innost - 博客园</title>
<link type="text/css" rel="stylesheet" href="1931456_files/common.css">
<link id="MainCss" type="text/css" rel="stylesheet" href="1931456_files/style.css">
<link type="text/css" rel="stylesheet" href="1931456_files/common2.css">
<link type="text/css" rel="stylesheet" href="1931456_files/shStyle.css">
<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/innost/rss">
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/innost/rsd.xml">
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/innost/wlwmanifest.xml">
<script src="1931456_files/gpt.js" type="text/javascript" async=""></script><script src="1931456_files/ga.js" async="" type="text/javascript"></script><script src="1931456_files/jquery.js" type="text/javascript"></script>  
<script type="text/javascript">
var currentBlogApp = 'innost';
</script>
<script src="1931456_files/common.js" type="text/javascript"></script> 
<script src="1931456_files/json2.js" type="text/javascript"></script>
<script type="text/javascript" src="1931456_files/syntaxHighlighter.js"></script>
<script src="1931456_files/google_ads_gpt.js" type="text/javascript" async=""></script><script src="1931456_files/osd.js" type="text/javascript"></script></head>
<body>
<a name="top"></a>

<div id="home">
<div id="header">
	<div id="blogTitle">
		
<!--done-->
<div class="title"><a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.cnblogs.com/innost/">innost</a></div>
<div class="subtitle">《深入理解Android卷II》即将发布，感谢大家对本系列丛书的支持。</div>



		
	</div><!--end: blogTitle 博客的标题和副标题 -->
	<div id="navigator">
		
<ul id="navList">
<li><a id="MyLinks1_HomeLink" class="menu" href="http://www.cnblogs.com/">博客园</a></li>
<li><a id="MyLinks1_MyHomeLink" class="menu" href="http://www.cnblogs.com/innost/">首页</a></li>
<li><a class="menu" href="http://q.cnblogs.com/">博问</a></li>
<li><a class="menu" href="http://home.cnblogs.com/ing/">闪存</a></li>
<li><a id="MyLinks1_NewPostLink" class="menu" rel="nofollow" href="http://www.cnblogs.com/innost/admin/EditPosts.aspx?opt=1">新随笔</a></li>
<li><a id="MyLinks1_ContactLink" class="menu" rel="nofollow" href="http://space.cnblogs.com/msg/send/innost">联系</a></li>
<li><a id="MyLinks1_Syndication" class="menu" href="http://www.cnblogs.com/innost/rss">订阅</a>
<!--<a id="MyLinks1_XMLLink" class="aHeaderXML" href="http://www.cnblogs.com/innost/rss"><img src="/Skins/Custom/images/rss.gif" alt="订阅" /></a>--></li>
<li><a id="MyLinks1_Admin" class="menu" rel="nofollow" href="http://www.cnblogs.com/innost/admin/EditPosts.aspx">管理</a></li>
</ul>

		<div class="blogStats">
			
			
<!--done-->
随笔-48&nbsp;
文章-1&nbsp;
评论-295&nbsp;

			
		</div><!--end: blogStats -->
	</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->
<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		
	
<!--done-->
<div id="topics">
	<div class="post">
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html">Android深入浅出之Binder机制</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body"><p>
</p><p class="11"><span lang="EN-US">Android</span>深入浅出之<span lang="EN-US">Binder</span>机制</p>
<p class="23"><span style="font-family: 黑体; mso-ascii-font-family: Helvetica;">一</span>
<span style="font-family: 黑体; mso-ascii-font-family: Helvetica;">说明</span></p>
<p class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;</span>Android</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">系统最常见也是初学者最难搞明白的就是</span><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">了，很多很多的</span><span lang="EN-US">Service</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">就是通过</span><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">机制来和客户端通讯交互的。所以搞明白</span><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的话，在很大程度上就能理解程序运行的流程。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">我们这里将以</span><span lang="EN-US">MediaService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的例子来分析</span><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的使用：</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">ServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，这是</span><span lang="EN-US">Android OS</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的整个服务的管理程序</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">MediaService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，这个程序里边注册了提供媒体播放的服务程序</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，我们最后只分析这个</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">MediaPlayerClient</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，这个是与</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">交互的客户端程序</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">下面先讲讲</span><span lang="EN-US">MediaService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">应用程序。</span></p>
<p class="23"><span style="font-family: 黑体; mso-ascii-font-family: Helvetica;">二</span><span lang="EN-US"> MediaService</span><span style="font-family: 黑体; mso-ascii-font-family: Helvetica;">的诞生</span></p>
<p class="MsoNormal"><span lang="EN-US">MediaService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">是一个应用程序，虽然</span><span lang="EN-US">Android</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">搞了七七八八的</span><span lang="EN-US">JAVA</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">之类的东西，但是在本质上，它还是一个完整的</span><span lang="EN-US">Linux</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">操作系统，也还没有牛到什么应用程序都是</span><span lang="EN-US">JAVA</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">写。所以，</span><span lang="EN-US">MS(MediaService)</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">就是一个和普通的</span><span lang="EN-US">C++</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">应用程序一样的东西。</span></p>
<p class="MsoNormal"><span lang="EN-US">MediaService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的源码文件在：</span><span lang="EN-US">framework\base\Media\MediaServer\Main_mediaserver.cpp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中。让我们看看到底是个什么玩意儿！</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">int main(int argc,
char** argv)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 1;"> </span>//FT</span>，就这么简单？？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>获得一个<span lang="EN-US">ProcessState</span>实例</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">sp&lt;ProcessState&gt;
proc(ProcessState::self());</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>得到一个<span lang="EN-US">ServiceManager</span>对象</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sp&lt;IServiceManager&gt; sm =
defaultServiceManager();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>MediaPlayerService::instantiate();//</span>初始化<span lang="EN-US">MediaPlayerService</span>服务</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>ProcessState::self()-&gt;startThreadPool();//</span>看名字，启动<span lang="EN-US">Process</span>的线程池？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;
</span>IPCThreadState::self()-&gt;joinThreadPool();//</span>将自己加入到刚才的线程池？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">其中，我们只分析</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">这么多疑问，看来我们只有一个个函数深入分析了。不过，这里先简单介绍下</span><span lang="EN-US">sp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">这个东西。</span></p>
<p class="MsoNormal"><span lang="EN-US">sp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，究竟是</span><span lang="EN-US">smart
pointer</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">还是</span><span lang="EN-US">strong pointer</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">呢？其实我后来发现不用太关注这个，就把它当做一个普通的指针看待，即</span><span lang="EN-US">sp&lt;IServiceManager&gt;======</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">》</span><span lang="EN-US">IServiceManager*</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">吧。</span><span lang="EN-US">sp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">是</span><span lang="EN-US">google</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">搞出来的为了方便</span><span lang="EN-US">C/C++</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">程序员管理指针的分配和释放的一套方法，类似</span><span lang="EN-US">JAVA</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的什么</span><span lang="EN-US">WeakReference</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">之类的。我个人觉得，要是自己写程序的话，不用这个东西也成。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">好了，以后的分析中，</span><span lang="EN-US">sp&lt;XXX&gt;</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">就看成是</span><span lang="EN-US">XXX*</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">就可以了。</span></p>
<h3><span lang="EN-US">2.1 ProcessState</span></h3>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">第一个调用的函数是</span><span lang="EN-US">ProcessState::self()</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，然后赋值给了</span><span lang="EN-US">proc</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">变量，程序运行完，</span><span lang="EN-US">proc</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">会自动</span><span lang="EN-US">delete</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">内部的内容，所以就自动释放了先前分配的资源。</span></p>
<p class="MsoNormal"><span lang="EN-US">ProcessState</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">位置在</span><span lang="EN-US">framework\base\libs\binder\ProcessState.cpp</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">sp&lt;ProcessState&gt;
ProcessState::self()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if (gProcess != NULL) return gProcess;----&gt;</span>第一次进来肯定不走这儿</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>AutoMutex _l(gProcessMutex);---&gt;</span>锁保护</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if (gProcess == NULL) gProcess = new
ProcessState;---&gt;</span>创建一个<span lang="EN-US">ProcessState</span>对象</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">return
gProcess;---&gt;</span>看见没，这里返回的是指针，但是函数返回的是<span lang="EN-US">sp&lt;xxx&gt;</span>，所以</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>把<span lang="EN-US">sp&lt;xxx&gt;</span>看成是<span lang="EN-US">XXX*</span>是可以的</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">再来看看<span lang="EN-US">ProcessState</span>构造函数</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>这个构造函数看来很重要</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">ProcessState::ProcessState()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>: mDriverFD(open_driver())-----&gt;Android</span>很多代码都是这么写的<span lang="EN-US">,</span>稍不留神就没看见这里调用了一个很重要的函数</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>, mVMStart(MAP_FAILED)//</span>映射内存的起始地址</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>, mManagesContexts(false)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>, mBinderContextCheckFunc(NULL)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>, mBinderContextUserData(NULL)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>, mThreadPoolStarted(false)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>, mThreadPoolSeq(1)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">if
(mDriverFD &gt;= 0) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//BIDNER_VM_SIZE</span>定义为<span lang="EN-US">(1*1024*1024) - (4096 *2) 1M-8K</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>mVMStart = mmap(0, BINDER_VM_SIZE,
PROT_READ, MAP_PRIVATE | MAP_NORESERVE,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 54.0pt; mso-char-indent-count: 6.0; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;</span>mDriverFD, 0);//</span>这个需要你自己去<span lang="EN-US">man mmap</span>的用法了，不过大概意思就是</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 54.0pt; mso-char-indent-count: 6.0; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>将<span lang="EN-US">fd</span>映射为内存，这样内存的<span lang="EN-US">memcpy</span>等操作就相当于<span lang="EN-US">write/read(fd)</span>了</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>...</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;">最讨厌这种在构造<span lang="EN-US">list</span>中添加函数的写法了，常常疏忽某个变量的初始化是一个函数调用的结果</span>。</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">open_driver</span>，就是打开<span lang="EN-US">/dev/binder</span>这个设备，这个是<span lang="EN-US">android</span>在内核中搞的一个专门用于完成</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">进程间通讯而设置的一个虚拟的设备。<span lang="EN-US">BTW</span>，说白了就是内核的提供的一个机制，这个和我们用<span lang="EN-US">socket</span>加<span lang="EN-US">NET_LINK</span>方式和内核通讯是一个道理。</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">static int
open_driver()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>int fd = open("/dev/binder",
O_RDWR);//</span>打开<span lang="EN-US">/dev/binder</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if (fd &gt;= 0) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span><span style="mso-tab-count: 1;">&nbsp;&nbsp; </span>....
</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>size_t maxThreads = 15;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span>通过<span lang="EN-US">ioctl</span>方式告诉内核，这个<span lang="EN-US">fd</span>支持最大线程数是<span lang="EN-US">15</span>个。</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>result = ioctl(fd,
BINDER_SET_MAX_THREADS, &amp;maxThreads);<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;
</span>} </span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">return
fd;</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">好了，到这里</span><span lang="EN-US">Process::self</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">就分析完了，到底干什么了呢？</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">打开</span><span lang="EN-US">/dev/binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">设备，这样的话就相当于和内核</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">机制有了交互的通道</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">映射</span><span lang="EN-US">fd</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">到内存，设备的</span><span lang="EN-US">fd</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">传进去后，估计这块内存是和</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">设备共享的</span></p>
<p class="MsoNormal"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">接下来，就到调用</span><span lang="EN-US">defaultServiceManager()</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">地方了。</span></p>
<h3><span lang="EN-US">2.2 defaultServiceManager</span></h3>
<p class="MsoNormal"><span lang="EN-US">defaultServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">位置在</span><span lang="EN-US">framework\base\libs\binder\IServiceManager.cpp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">sp&lt;IServiceManager&gt;
defaultServiceManager()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if (gDefaultServiceManager != NULL) return
gDefaultServiceManager;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>//</span>又是一个单例，设计模式中叫<span lang="EN-US">
singleton</span>。</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>AutoMutex
_l(gDefaultServiceManagerLock);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (gDefaultServiceManager == NULL) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 1;"> </span>//</span>真正的<span lang="EN-US">gDefaultServiceManager</span>是在这里创建的喔</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>gDefaultServiceManager =
interface_cast&lt;IServiceManager&gt;(</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ProcessState::self()-&gt;getContextObject(NULL));</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>return gDefaultServiceManager;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">-----</span>》</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">gDefaultServiceManager
= interface_cast&lt;IServiceManager&gt;(</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ProcessState::self()-&gt;getContextObject(NULL));</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">ProcessState::self</span>，肯定返回的是刚才创建的<span lang="EN-US">gProcess</span>，然后调用它的<span lang="EN-US">getContextObject</span>，注意，传进去的是<span lang="EN-US">NULL</span>，即<span lang="EN-US">0</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>回到<span lang="EN-US">ProcessState</span>类，</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">sp&lt;IBinder&gt;
ProcessState::getContextObject(const sp&lt;IBinder&gt;&amp; caller)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">if
(supportsProcesses()) {//</span>该函数根据打开设备是否成功来判断是否支持<span lang="EN-US">process</span>，</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>在真机上肯定走这个</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return getStrongProxyForHandle(0);//</span>注意，这里传入<span lang="EN-US">0</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>} </span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">----</span>》进入到<span lang="EN-US">getStrongProxyForHandle</span>，函数名字怪怪的，经常严重阻碍大脑运转</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>注意这个参数的命名，<span lang="EN-US">handle</span>。搞过<span lang="EN-US">windows</span>的应该比较熟悉这个名字，这是对</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>资源的一种标示，其实说白了就是某个数据结构，保存在数组中，然后<span lang="EN-US">handle</span>是它在这个数组中的索引。<span lang="EN-US">---&gt;</span>就是这么一个玩意儿</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">sp&lt;IBinder&gt;
ProcessState::getStrongProxyForHandle(int32_t handle)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sp&lt;IBinder&gt; result;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>AutoMutex _l(mLock);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">handle_entry*
e = lookupHandleLocked(handle);--</span>》哈哈，果然，从数组中查找对应</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471">索引的资源，<span lang="EN-US">lookupHandleLocked</span>这个就不说了，内部会返回一个<span lang="EN-US">handle_entry</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 1;"> </span><span style="mso-spacerun: yes;">&nbsp;</span></span>下面是<span lang="EN-US"> handle_entry </span>的结构</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">/*</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 1;"> </span>struct handle_entry {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>IBinder* binder;---&gt;Binder</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>RefBase::weakref_type* refs;--&gt;</span>不知道是什么，不影响<span lang="EN-US">.</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>};</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">*/</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if (e != NULL) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IBinder* b = e-&gt;binder; --&gt;</span>第一次进来，肯定为空</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (b == NULL ||
!e-&gt;refs-&gt;attemptIncWeak(this)) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>b = new BpBinder(handle); ---&gt;</span>看见了吧，创建了一个新的<span lang="EN-US">BpBinder</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>e-&gt;binder = b;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;</span>result = b;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}....</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>return result; </span>返回刚才创建的<span lang="EN-US">BpBinder</span>。</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">到这里，是不是有点乱了？对，当人脑分析的函数调用太深的时候，就容易忘记。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">我们是从<span lang="EN-US">gDefaultServiceManager
= interface_cast&lt;IServiceManager&gt;(</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ProcessState::self()-&gt;getContextObject(NULL));</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">开始搞的，现在，这个函数调用将变成</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">gDefaultServiceManager
= interface_cast&lt;IServiceManager&gt;(new BpBinder(0));</span></p>
</div>
<p class="MsoNormal"><span lang="EN-US">BpBinder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">又是个什么玩意儿？</span><span lang="EN-US">Android</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">名字起得太眼花缭乱了。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">因为还没介绍</span><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">机制的大架构，所以这里介绍</span><span lang="EN-US">BpBinder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">不合适，但是又讲到</span><span lang="EN-US">BpBinder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">了，不介绍</span><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">架构似乎又说不清楚</span><span lang="EN-US">....</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，</span><span lang="EN-US">sigh</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">！</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">恩，还是继续把层层深入的函数调用栈化繁为简吧，至少大脑还可以工作。先看看</span><span lang="EN-US">BpBinder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的构造函数把。</span></p>
<h3><span lang="EN-US">2.3 BpBinder</span></h3>
<p class="MsoNormal"><span lang="EN-US">BpBinder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">位置在</span><span lang="EN-US">framework\base\libs\binder\BpBinder.cpp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中。</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">BpBinder::BpBinder(int32_t
handle)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>: mHandle(handle) //</span>注意，接上述内容，这里调用的时候传入的是<span lang="EN-US">0</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>, mAlive(1)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>, mObitsSent(0)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>, mObituaries(NULL)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;
</span>IPCThreadState::self()-&gt;incWeakHandle(handle);//FT</span>，竟然到<span lang="EN-US">IPCThreadState::self()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">这里一块说说吧，<span lang="EN-US">IPCThreadState::self</span>估计怎么着又是一个<span lang="EN-US">singleton</span>吧？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>该文件位置在<span lang="EN-US">framework\base\libs\binder\IPCThreadState.cpp</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">IPCThreadState*
IPCThreadState::self()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;</span>if
(gHaveTLS) {//</span>第一次进来为<span lang="EN-US">false</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">restart:</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>const pthread_key_t k = gTLS;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//TLS</span><span style="color: red;">是<span lang="EN-US">Thread Local Storage</span>的意思，不懂得自己去<span lang="EN-US">google</span>下它的作用吧。这里只需要<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">知道这种空间每个线程有一个，而且线程间不共享这些空间，好处是？我就不用去搞什么<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">同步了。在这个线程，我就用这个线程的东西，反正别的线程获取不到其他线程<span lang="EN-US">TLS</span>中的数据。<span lang="EN-US">===</span>》这句话有漏洞，钻牛角尖的明白大概意思就可以了。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">从线程本地存储空间中获得保存在其中的<span lang="EN-US">IPCThreadState</span>对象<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">这段代码写法很晦涩，看见没，只有<span lang="EN-US">pthread_getspecific,</span>那么肯定有地方调用<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//
pthread_setspecific</span><span style="color: red;">。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IPCThreadState* st =
(IPCThreadState*)pthread_getspecific(k);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (st) return st;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return new IPCThreadState;//new</span>一个对象，</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;</span>if
(gShutdown) return NULL;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>pthread_mutex_lock(&amp;gTLSMutex);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if (!gHaveTLS) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (pthread_key_create(&amp;gTLS,
threadDestructor) != 0) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>pthread_mutex_unlock(&amp;gTLSMutex);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return NULL;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>gHaveTLS = true;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>pthread_mutex_unlock(&amp;gTLSMutex);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">goto
restart; </span><span style="color: red;" lang="EN-US">//</span><span style="color: red;">我<span lang="EN-US">FT</span>，其实<span lang="EN-US">goto</span>没有我们说得那样卑鄙，汇编代码很多跳转语句的。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">关键是要用好。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>这里是构造函数，在构造函数里边<span lang="EN-US">pthread_setspecific</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">IPCThreadState::IPCThreadState()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>: mProcess(ProcessState::self()),
mMyThreadId(androidGetTid())</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>pthread_setspecific(gTLS, this);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>clearCaller();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">mIn.setDataCapacity(256);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//mIn,mOut</span><span style="color: red;">是两个<span lang="EN-US">Parcel</span>，干嘛用的啊？把它看成是命令的<span lang="EN-US">buffer</span>吧。再深入解释，又会大脑停摆的。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>mOut.setDataCapacity(256);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">出来了，终于出来了</span><span lang="EN-US">....</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，恩，回到</span><span lang="EN-US">BpBinder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">那。</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">BpBinder::BpBinder(int32_t
handle)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>: mHandle(handle) //</span>注意，接上述内容，这里调用的时候传入的是<span lang="EN-US">0</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>, mAlive(1)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>, mObitsSent(0)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>, mObituaries(NULL)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 1;"> </span>......</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">IPCThreadState::self()-&gt;incWeakHandle(handle);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471">什么<span lang="EN-US">incWeakHandle</span>，不讲了<span lang="EN-US">..</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">喔，</span><span lang="EN-US">new BpBinder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">就算完了。到这里，我们创建了些什么呢？</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">ProcessState</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">有了。</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">IPCThreadState</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">有了，而且是主线程的。</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">BpBinder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">有了，内部</span><span lang="EN-US">handle</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">值为</span><span lang="EN-US">0</span></p>
<p class="MsoNormal"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><span lang="EN-US">gDefaultServiceManager =
interface_cast&lt;IServiceManager&gt;(new BpBinder(0));</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">终于回到原点了，大家是不是快疯掉了？</span></p>
<p class="MsoNormal"><span lang="EN-US">interface_cast</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，我第一次接触的时候，把它看做类似的</span><span lang="EN-US">static_cast</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">一样的东西，然后死活也搞不明白</span><span lang="EN-US"> BpBinder*</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">指针怎么能强转为</span><span lang="EN-US">IServiceManager*</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，花了</span><span lang="EN-US">n</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">多时间查看</span><span lang="EN-US">BpBinder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">是否和</span><span lang="EN-US">IServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">继承还是咋的</span><span lang="EN-US">....</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">终于，我用</span><span lang="EN-US">ctrl+</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">鼠标</span><span lang="EN-US">(source insight)</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">跟踪进入了</span><span lang="EN-US">interface_cast</span></p>
<p class="MsoNormal"><span lang="EN-US">IInterface.h</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">位于</span><span lang="EN-US">framework/base/include/binder/IInterface.h</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">template&lt;typename
INTERFACE&gt;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">inline
sp&lt;INTERFACE&gt; interface_cast(const sp&lt;IBinder&gt;&amp; obj)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>return INTERFACE::asInterface(obj);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">所以，上面等价于：</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">inline sp&lt;IServiceManager&gt;
interface_cast(const sp&lt;IBinder&gt;&amp; obj)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>return IServiceManager::asInterface(obj);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">看来，只能跟到<span lang="EN-US">IServiceManager</span>了。</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">IServiceManager.h---</span>》<span lang="EN-US">framework/base/include/binder/IServiceManager.h</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">看看它是如何定义的<span lang="EN-US">:</span></p>
</div>
<h3><span lang="EN-US">2.4 IServiceManager</span></h3>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">class
IServiceManager : public IInterface</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//ServiceManager,</span>字面上理解就是<span lang="EN-US">Service</span>管理类，管理什么？增加服务，查询服务等</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>这里仅列出增加服务<span lang="EN-US">addService</span>函数</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">public:</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>DECLARE_META_INTERFACE(ServiceManager);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span>virtual status_t<span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>addService( const String16&amp; name,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>const sp&lt;IBinder&gt;&amp; service) = 0;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">};</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">DECLARE_META_INTERFACE(ServiceManager)</span>？？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">怎么和<span lang="EN-US">MFC</span>这么类似？微软的影响很大啊！知道<span lang="EN-US">MFC</span>的，有<span lang="EN-US">DELCARE</span>肯定有<span lang="EN-US">IMPLEMENT</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">果然，这两个宏<span lang="EN-US">DECLARE_META_INTERFACE</span>和<span lang="EN-US">IMPLEMENT_META_INTERFACE(INTERFACE, NAME)</span>都在</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">刚才的<span lang="EN-US">IInterface.h</span>中定义。我们先看看<span lang="EN-US">DECLARE_META_INTERFACE</span>这个宏往<span lang="EN-US">IServiceManager</span>加了什么？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">下面是<span lang="EN-US">DECLARE</span>宏</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">#define
DECLARE_META_INTERFACE(INTERFACE)<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>static const android::String16
descriptor;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>static android::sp&lt;I##INTERFACE&gt;
asInterface(<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>const
android::sp&lt;android::IBinder&gt;&amp; obj);<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>virtual const android::String16&amp;
getInterfaceDescriptor() const;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>I##INTERFACE();<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>virtual ~I##INTERFACE();<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">我们把它兑现到<span lang="EN-US">IServiceManager</span>就是：</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">static const
android::String16 descriptor;<span style="mso-spacerun: yes;">&nbsp; </span>--&gt;</span>喔，增加一个描述字符串</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">static
android::sp&lt; IServiceManager &gt; asInterface(const
android::sp&lt;android::IBinder&gt;&amp; </span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">obj) ---</span>》增加一个<span lang="EN-US">asInterface</span>函数</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">virtual const
android::String16&amp; getInterfaceDescriptor() const; ---</span>》增加一个<span lang="EN-US">get</span>函数</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">估计其返回值就是<span lang="EN-US">descriptor</span>这个字符串</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">IServiceManager
();<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">virtual ~IServiceManager();</span>增加构造和虚析购函数<span lang="EN-US">...</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">那</span><span lang="EN-US">IMPLEMENT</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">宏在哪定义的呢？</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">见</span><span lang="EN-US">IServiceManager.cpp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。位于</span><span lang="EN-US">framework/base/libs/binder/IServiceManager.cpp</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">IMPLEMENT_META_INTERFACE(ServiceManager,
"android.os.IServiceManager");</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">下面是这个宏的定义</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">#define
IMPLEMENT_META_INTERFACE(INTERFACE, NAME)<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>const android::String16
I##INTERFACE::descriptor(NAME);<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>const android::String16&amp;<span style="mso-spacerun: yes;">&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>I##INTERFACE::getInterfaceDescriptor() const {<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return I##INTERFACE::descriptor;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>android::sp&lt;I##INTERFACE&gt;
I##INTERFACE::asInterface(<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>const
android::sp&lt;android::IBinder&gt;&amp; obj)<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>android::sp&lt;I##INTERFACE&gt;
intr;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (obj != NULL) {<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>intr =
static_cast&lt;I##INTERFACE*&gt;(<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>obj-&gt;queryLocalInterface(<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>I##INTERFACE::descriptor).get());<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (intr == NULL) {<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>intr = new
Bp##INTERFACE(obj);<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return intr;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>I##INTERFACE::I##INTERFACE() { }<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">I##INTERFACE::~I##INTERFACE()
{ }<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>\</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471">很麻烦吧？尤其是宏看着头疼。赶紧兑现下吧。</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">const
</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">android::String16
IServiceManager::descriptor(“android.os.IServiceManager”); </span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">const
android::String16&amp; IServiceManager::getInterfaceDescriptor() const</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;</span>{<span style="mso-spacerun: yes;">&nbsp;
</span>return IServiceManager::descriptor;//</span>返回上面那个<span lang="EN-US">android.os.IServiceManager</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;</span>}<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>android::sp&lt;IServiceManager&gt; IServiceManager::asInterface(</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>const
android::sp&lt;android::IBinder&gt;&amp; obj)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{ </span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>android::sp&lt;IServiceManager&gt;
intr;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (obj != NULL) {<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>intr = static_cast&lt;IServiceManager
*&gt;(<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>obj-&gt;queryLocalInterface(IServiceManager::descriptor).get());<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (intr == NULL) {<span style="mso-spacerun: yes;">&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>intr = new BpServiceManager(obj);<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;</span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return intr;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>IServiceManager::IServiceManager () {
}<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>IServiceManager::~ IServiceManager() { }</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;</span></span><span style="color: red;">哇塞，<span lang="EN-US">asInterface</span>是这么搞的啊，赶紧分析下吧，还是不知道<span lang="EN-US">interface_cast</span>怎么把<span lang="EN-US">BpBinder*</span>转成了<span lang="EN-US">IServiceManager <o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;">我们刚才解析过的<span lang="EN-US">interface_cast&lt;IServiceManager&gt;(new BpBinder(0)),<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;">原来就是调用<span lang="EN-US">asInterface(new BpBinder(0))<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">android::sp&lt;IServiceManager&gt;
IServiceManager::asInterface(</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>const
android::sp&lt;android::IBinder&gt;&amp; obj)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{ </span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>android::sp&lt;IServiceManager&gt;
intr;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (obj != NULL) {<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>....<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>intr = new BpServiceManager(obj);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>神呐，终于看到和<span lang="EN-US">IServiceManager</span>相关的东西了，看来</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>实际返回的是<span lang="EN-US">BpServiceManager(new BpBinder(0))</span>；<span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>return intr;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span></span></p>
</div>
<p class="MsoNormal"><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">是个什么玩意儿？</span><span lang="EN-US">p</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">是什么个意思？</span></p>
<h3><span lang="EN-US">2.5 BpServiceManager</span></h3>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">终于可以讲解点架构上的东西了。</span><span lang="EN-US">p</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">是</span><span lang="EN-US">proxy</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">即代理的意思，</span><span lang="EN-US">Bp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">就是</span><span lang="EN-US">BinderProxy</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，</span><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，就是</span><span lang="EN-US">SM</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的</span><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">代理。既然是代理，那肯定希望对用户是透明的，那就是说头文件里边不会有这个</span><span lang="EN-US">Bp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的定义。是吗？</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">果然，</span><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">就在刚才的</span><span lang="EN-US">IServiceManager.cpp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中定义。</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">class
BpServiceManager : public BpInterface&lt;IServiceManager&gt;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">这种继承方式，表示同时继承<span lang="EN-US">BpInterface</span>和<span lang="EN-US">IServiceManager</span>，这样<span lang="EN-US">IServiceManger</span>的<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">addService</span><span style="color: red;">必然在这个类中实现</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">public:</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">注意构造函数参数的命名<span lang="EN-US"> impl</span>，难道这里使用了<span lang="EN-US">Bridge</span>模式？真正完成操作的是<span lang="EN-US">impl</span>对象？<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">这里传入的<span lang="EN-US">impl</span>就是<span lang="EN-US">new
BpBinder(0)<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>BpServiceManager(const
sp&lt;IBinder&gt;&amp; impl)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>:
BpInterface&lt;IServiceManager&gt;(impl)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span>virtual status_t addService(const
String16&amp; name, const sp&lt;IBinder&gt;&amp; service)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span>待会再说<span lang="EN-US">..</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">基类<span lang="EN-US">BpInterface</span>的构造函数（经过兑现后）<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">这里的参数又叫<span lang="EN-US">remote</span>，唉，真是害人不浅啊。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">inline
BpInterface&lt; IServiceManager &gt;::BpInterface(const sp&lt;IBinder&gt;&amp;
remote)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>: BpRefBase(remote)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">BpRefBase::BpRefBase(const
sp&lt;IBinder&gt;&amp; o)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>: mRemote(o.get()), mRefs(NULL), mState(0)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//o.get()</span><span style="color: red;">，这个是<span lang="EN-US">sp</span>类的获取实际数据指针的一个方法，你只要知道<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">它返回的是<span lang="EN-US">sp&lt;xxxx&gt;</span>中<span lang="EN-US">xxx* </span>指针就行<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//mRemote</span><span style="color: red;">就是刚才的<span lang="EN-US">BpBinder(0)<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>...</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">好了，到这里，我们知道了：</span></p>
<p class="MsoNormal"><span lang="EN-US">sp&lt;IServiceManager&gt; sm =
defaultServiceManager(); </span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">返回的实际是</span><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，它的</span><span lang="EN-US">remote</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">对象是</span><span lang="EN-US">BpBinder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，传入的那个</span><span lang="EN-US">handle</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">参数是</span><span lang="EN-US">0</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">现在重新回到</span><span lang="EN-US">MediaService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">int main(int argc,
char** argv)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sp&lt;ProcessState&gt;
proc(ProcessState::self());</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">sp&lt;IServiceManager&gt;
sm = defaultServiceManager();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>上面的讲解已经完了</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">MediaPlayerService::instantiate();//</span>实例化<span lang="EN-US">MediaPlayerservice</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>看来这里有名堂！</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>ProcessState::self()-&gt;startThreadPool();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>IPCThreadState::self()-&gt;joinThreadPool();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">到这里，我们把</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">设备打开了，得到一个</span><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">对象，这表明我们可以和</span><span lang="EN-US">SM</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">打交道了，但是好像没干什么有意义的事情吧？</span></p>
<h3><span lang="EN-US">2.6 MediaPlayerService</span></h3>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">那下面我们看看后续又干了什么？以</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">为例。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">它位于</span><span lang="EN-US">framework\base\media\libmediaplayerservice\libMediaPlayerService.cpp</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">void
MediaPlayerService::instantiate() {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">defaultServiceManager()-&gt;addService(</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>传进去服务的名字，传进去<span lang="EN-US">new</span>出来的对象</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>String16("media.player"),
new MediaPlayerService());</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">MediaPlayerService::MediaPlayerService()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>LOGV("MediaPlayerService
created");//</span>太简单了</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>mNextConnId = 1;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">defaultServiceManager</span>返回的是刚才创建的<span lang="EN-US">BpServiceManager</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">调用它的<span lang="EN-US">addService</span>函数。</p>
</div>
<p class="MsoNormal"><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">从</span><span lang="EN-US">BnMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">派生</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">class
MediaPlayerService : public BnMediaPlayerService</span></p>
</div>
<p class="MsoNormal"><span lang="EN-US">FT</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">从</span><span lang="EN-US">BnMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">派生，</span><span lang="EN-US">BnXXX,BpXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，快晕了。</span></p>
<p class="MsoNormal"><span lang="EN-US">Bn </span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">是</span><span lang="EN-US">Binder Native</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的含义，是和</span><span lang="EN-US">Bp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">相对的，</span><span lang="EN-US">Bp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的</span><span lang="EN-US">p</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">是</span><span lang="EN-US">proxy</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">代理的意思，那么另一端一定有一个和代理打交道的东西，这个就是</span><span lang="EN-US">Bn</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">讲到这里会有点乱喔。先分析下，到目前为止都构造出来了什么。</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">BpServiceManager</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">BnMediaPlayerService</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">这两个东西不是相对的两端，从</span><span lang="EN-US">BnXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">就可以判断，</span><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">对应的应该是</span><span lang="EN-US">BnServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，</span><span lang="EN-US">BnMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">对应的应该是</span><span lang="EN-US">BpMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">我们现在在哪里</span><span lang="EN-US">?</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">对了，我们现在是创建了</span><span lang="EN-US">BnMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，想把它加入到系统的中去。</span></p>
<p style="text-indent: 0cm;" class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">喔，明白了。我创建一个新的</span><span lang="EN-US">Service—BnMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，想把它告诉</span><span lang="EN-US">ServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。</span></p>
<p style="text-indent: 0cm;" class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">那我怎么和</span><span lang="EN-US">ServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">通讯呢？恩，利用</span><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。所以嘛，我调用了</span><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的</span><span lang="EN-US">addService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">函数！</span></p>
<p style="text-indent: 0cm;" class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">为什么要搞个</span><span lang="EN-US">ServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">来呢？这个和</span><span lang="EN-US">Android</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">机制有关系。所有</span><span lang="EN-US">Service</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">都需要加入到</span><span lang="EN-US">ServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">来管理。同时也方便了</span><span lang="EN-US">Client</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">来查询系统存在哪些</span><span lang="EN-US">Service</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，没看见我们传入了字符串吗？这样就可以通过</span><span lang="EN-US">Human Readable</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的字符串来查找</span><span lang="EN-US">Service</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">了。</span></p>
<p style="text-indent: 0cm;" class="MsoNormal"><span lang="EN-US">---</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">》感觉没说清楚</span><span lang="EN-US">...</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">饶恕我吧。</span></p>
<h3><span lang="EN-US">2.7 addService</span></h3>
<p class="MsoNormal"><span lang="EN-US">addService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">是调用的</span><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的函数。前面略去没讲，现在我们看看。</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">virtual status_t
addService(const String16&amp; name, const sp&lt;IBinder&gt;&amp; service)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Parcel data, reply;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//data</span><span style="color: red;">是发送到<span lang="EN-US">BnServiceManager</span>的命令包<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">看见没？先把<span lang="EN-US">Interface</span>名字写进去，也就是什么<span lang="EN-US">android.os.IServiceManager<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>data.writeInterfaceToken(IServiceManager::getInterfaceDescriptor());</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">再把新<span lang="EN-US">service</span>的名字写进去 叫<span lang="EN-US">media.player<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>data.writeString16(name);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">把新服务<span lang="EN-US">service—&gt;</span>就是<span lang="EN-US">MediaPlayerService</span>写到命令中<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>data.writeStrongBinder(service);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">调用<span lang="EN-US">remote</span>的<span lang="EN-US">transact</span>函数<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>status_t err =
remote()-&gt;transact(ADD_SERVICE_TRANSACTION, data, &amp;reply);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return err == NO_ERROR ?
reply.readInt32() : err;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">我的天，</span><span lang="EN-US">remote()</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">返回的是什么？</span></p>
<p class="MsoNormal"><span lang="EN-US">remote(){ return mRemote; }--&gt;</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">啊？找不到对应的实际对象了？？？</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">还记得我们刚才初始化时候说的：</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">“这里的参数又叫</span><span lang="EN-US">remote</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，唉，真是害人不浅啊“</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">原来，这里的</span><span lang="EN-US">mRemote</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">就是最初创建的</span><span lang="EN-US">BpBinder..</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">好吧，到那里去看看：</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">BpBinder</span>的位置在<span lang="EN-US">framework\base\libs\binder\BpBinder.cpp</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">status_t
BpBinder::transact(</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>uint32_t code, const Parcel&amp; data,
Parcel* reply, uint32_t flags)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>又绕回去了，调用<span lang="EN-US">IPCThreadState</span>的<span lang="EN-US">transact</span>。</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>注意啊，这里的<span lang="EN-US">mHandle</span>为<span lang="EN-US">0,code</span>是<span lang="EN-US">ADD_SERVICE_TRANSACTION,data</span>是命令包</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//reply</span>是回复包，<span lang="EN-US">flags=0</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>status_t status =
IPCThreadState::self()-&gt;transact(</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>mHandle, code, data, reply, flags);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (status == DEAD_OBJECT) mAlive = 0;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return status;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">...</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">再看看<span lang="EN-US">IPCThreadState</span>的<span lang="EN-US">transact</span>函数把</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">status_t
IPCThreadState::transact(int32_t handle,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>uint32_t
code, const Parcel&amp; data,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>Parcel* reply,
uint32_t flags)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>status_t err = data.errorCheck();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>flags |= TF_ACCEPT_FDS;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if (err == NO_ERROR) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="color: red;" lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>//</span><span style="color: red;">调用<span lang="EN-US">writeTransactionData </span>发送数据<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 27.0pt; mso-char-indent-count: 3.0; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">err = writeTransactionData(BC_TRANSACTION, flags,
handle, code, data, NULL);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if ((flags &amp; TF_ONE_WAY) == 0) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (reply) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>err = waitForResponse(reply);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>} else {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Parcel fakeReply;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>err =
waitForResponse(&amp;fakeReply);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>....</span>等回复</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>err = waitForResponse(NULL, NULL);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 1;"> </span><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>....<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>return err;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;">再进一步，瞧瞧这个<span lang="EN-US">...<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">status_t
IPCThreadState::writeTransactionData(int32_t cmd, uint32_t binderFlags,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>int32_t handle, uint32_t code, const
Parcel&amp; data, status_t* statusBuffer)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>binder_transaction_data tr;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>tr.target.handle = handle;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>tr.code = code;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>tr.flags = binderFlags;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>const status_t err = data.errorCheck();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if (err == NO_ERROR) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>tr.data_size = data.ipcDataSize();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>tr.data.ptr.buffer = data.ipcData();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>tr.offsets_size = data.ipcObjectsCount()*sizeof(size_t);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>tr.data.ptr.offsets =
data.ipcObjects();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>} </span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">....</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">上面把命令数据封装成<span lang="EN-US">binder_transaction_data</span>，然后<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">写到<span lang="EN-US">mOut</span>中，<span lang="EN-US">mOut</span>是命令的缓冲区，也是一个<span lang="EN-US">Parcel<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>mOut.writeInt32(cmd);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>mOut.write(&amp;tr, sizeof(tr));</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">仅仅写到了<span lang="EN-US">Parcel</span>中，<span lang="EN-US">Parcel</span>好像没和<span lang="EN-US">/dev/binder</span>设备有什么关联啊？<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">恩，那只能在另外一个地方写到<span lang="EN-US">binder</span>设备中去了。难道是在？<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>return NO_ERROR;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">说对了，就是在<span lang="EN-US">waitForResponse</span>中<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">status_t
IPCThreadState::waitForResponse(Parcel *reply, status_t *acquireResult)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>int32_t cmd;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>int32_t err;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">while
(1) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//talkWithDriver</span>，哈哈，应该是这里了</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if ((err=talkWithDriver()) &lt;
NO_ERROR) break;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>err = mIn.errorCheck();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (err &lt; NO_ERROR) break;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (mIn.dataAvail() == 0) continue;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="color: red;" lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;</span>//</span><span style="color: red;">看见没？这里开始操作<span lang="EN-US">mIn</span>了，看来<span lang="EN-US">talkWithDriver</span>中<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">把<span lang="EN-US">mOut</span>发出去，然后从<span lang="EN-US">driver</span>中读到数据放到<span lang="EN-US">mIn</span>中了。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>cmd = mIn.readInt32();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>switch (cmd) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="color: red;" lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;</span>case
BR_TRANSACTION_COMPLETE:<o:p></o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (!reply &amp;&amp;
!acquireResult) goto finish;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>break;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>.....</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>return err;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">status_t
IPCThreadState::talkWithDriver(bool doReceive)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 1;"> </span>binder_write_read bwr;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span></span><span style="color: red;" lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;</span>//</span><span style="color: red;">中间东西太复杂了，不就是把<span lang="EN-US">mOut</span>数据和<span lang="EN-US">mIn</span>接收数据的处理后赋值给<span lang="EN-US">bwr</span>吗？<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>status_t err;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>do {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">用<span lang="EN-US">ioctl</span>来读写<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (ioctl(mProcess-&gt;mDriverFD,
BINDER_WRITE_READ, &amp;bwr) &gt;= 0)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>err = NO_ERROR;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>else</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>err = -errno;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span>} while (err == -EINTR);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">到这里，回复数据就在<span lang="EN-US">bwr</span>中了，<span lang="EN-US">bmr</span>接收回复数据的<span lang="EN-US">buffer</span>就是<span lang="EN-US">mIn</span>提供的<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (bwr.read_consumed &gt; 0) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>mIn.setDataSize(bwr.read_consumed);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>mIn.setDataPosition(0);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">return
NO_ERROR;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">好了，到这里，我们发送</span><span lang="EN-US">addService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的流程就彻底走完了。</span></p>
<p class="MsoNormal"><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">发送了一个</span><span lang="EN-US">addService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">命令到</span><span lang="EN-US">BnServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，然后收到回复。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">先继续我们的</span><span lang="EN-US">main</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">函数。</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">int main(int argc,
char** argv)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sp&lt;ProcessState&gt;
proc(ProcessState::self());</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sp&lt;IServiceManager&gt; sm =
defaultServiceManager();<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">MediaPlayerService::instantiate();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">---</span>》该函数内部调用<span lang="EN-US">addService</span>，把<span lang="EN-US">MediaPlayerService</span>信息<span lang="EN-US"> add</span>到<span lang="EN-US">ServiceManager</span>中</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>ProcessState::self()-&gt;startThreadPool();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;
</span>IPCThreadState::self()-&gt;joinThreadPool();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">这里有个容易搞晕的地方：</span></p>
<p class="MsoNormal"><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">是一个</span><span lang="EN-US">BnMediaPlayerService,</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">那么它是不是应该等着</span></p>
<p class="MsoNormal"><span lang="EN-US">BpMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">来和他交互呢</span><span lang="EN-US">?</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">但是我们没看见</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">有打开</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">设备的操作啊！</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">这个嘛，到底是继续</span><span lang="EN-US">addService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">操作的另一端</span><span lang="EN-US">BnServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">还是先说</span></p>
<p class="MsoNormal"><span lang="EN-US">BnMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">呢？</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">还是先说</span><span lang="EN-US">BnServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">吧。顺便把系统的</span><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">架构说说。</span></p>
<h3><span lang="EN-US">2.8 BnServiceManager</span></h3>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">上面说了，</span><span lang="EN-US">defaultServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">返回的是一个</span><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，通过它可以把命令请求发送到</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">设备，而且</span><span lang="EN-US">handle</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的值为</span><span lang="EN-US">0</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。那么，系统的另外一端肯定有个接收命令的，那又是谁呢？</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">很可惜啊，</span><span lang="EN-US">BnServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">不存在，但确实有一个程序完成了</span><span lang="EN-US">BnServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的工作，那就是</span><span lang="EN-US">service</span><span style="color: red;" lang="EN-US">.exe</span><span lang="EN-US">(</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">如果在</span><span lang="EN-US">windows</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">上一定有</span><span lang="EN-US">exe</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">后缀，叫</span><span lang="EN-US">service</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的名字太多了，这里加</span><span lang="EN-US">exe</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">就表明它是一个程序</span><span lang="EN-US">)</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">位置在</span><span lang="EN-US">framework/base/cmds/servicemanger.c</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中。</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">int main(int argc,
char **argv)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>struct binder_state *bs;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>void *svcmgr = BINDER_SERVICE_MANAGER;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>bs = binder_open(128*1024);//</span>应该是打开<span lang="EN-US">binder</span>设备吧？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>binder_become_context_manager(bs) //</span>成为<span lang="EN-US">manager</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>svcmgr_handle = svcmgr;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>binder_loop(bs, svcmgr_handler);//</span>处理<span lang="EN-US">BpServiceManager</span>发过来的命令</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">看看<span lang="EN-US">binder_open</span>是不是和我们猜得一样？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">struct binder_state
*binder_open(unsigned mapsize)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>struct binder_state *bs;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>bs = malloc(sizeof(*bs));</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>....</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>bs-&gt;fd = open("/dev/binder",
O_RDWR);//</span>果然如此</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span>....</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>bs-&gt;mapsize = mapsize;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>bs-&gt;mapped = mmap(NULL, mapsize,
PROT_READ, MAP_PRIVATE, bs-&gt;fd, 0);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">再看看<span lang="EN-US">binder_become_context_manager</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">int
binder_become_context_manager(struct binder_state *bs)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>return ioctl(bs-&gt;fd,
BINDER_SET_CONTEXT_MGR, 0);//</span>把自己设为<span lang="EN-US">MANAGER</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">binder_loop </span>肯定是从<span lang="EN-US">binder</span>设备中读请求，写回复的这么一个循环吧？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">void
binder_loop(struct binder_state *bs, binder_handler func)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>int res;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;</span>struct binder_write_read bwr;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>readbuf[0] = BC_ENTER_LOOPER;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>binder_write(bs, readbuf,
sizeof(unsigned));</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>for (;;) {//</span>果然是循环</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>bwr.read_size = sizeof(readbuf);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>bwr.read_consumed = 0;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>bwr.read_buffer = (unsigned) readbuf;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;</span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 2;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span>哈哈，收到请求了，解析命令</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>res = binder_parse(bs, 0, readbuf,
bwr.read_consumed, func);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">这个<span lang="EN-US">...</span>后面还要说吗？？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">恩，最后有一个类似<span lang="EN-US">handleMessage</span>的地方处理各种各样的命令。这个就是</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">svcmgr_handler,</span>就在<span lang="EN-US">ServiceManager.c</span>中</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">int
svcmgr_handler(struct binder_state *bs,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>struct binder_txn *txn,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>struct binder_io *msg,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>struct binder_io *reply)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>struct svcinfo *si;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>uint16_t *s;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>unsigned len;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>void *ptr;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>s = bio_get_string16(msg, &amp;len);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>switch(txn-&gt;code) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>case SVC_MGR_ADD_SERVICE:</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>s = bio_get_string16(msg, &amp;len);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ptr = bio_get_ref(msg);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (do_add_service(bs, s, len, ptr,
txn-&gt;sender_euid))</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return -1;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>break;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">...</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">其中，<span lang="EN-US">do_add_service</span>真正添加<span lang="EN-US">BnMediaService</span>信息</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">int
do_add_service(struct binder_state *bs,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>uint16_t *s, unsigned len,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>void *ptr, unsigned uid)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>struct svcinfo *si;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>si = find_svc(s, len);s</span>是一个<span lang="EN-US">list</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span>si = malloc(sizeof(*si) + (len + 1) *
sizeof(uint16_t));</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>si-&gt;ptr = ptr;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>si-&gt;len = len;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>memcpy(si-&gt;name, s, (len + 1) *
sizeof(uint16_t));</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>si-&gt;name[len] = '\0';</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>si-&gt;death.func = svcinfo_death;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>si-&gt;death.ptr = si;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>si-&gt;next = svclist;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>svclist = si; //</span>看见没，这个<span lang="EN-US">svclist</span>是一个列表，保存了当前注册到<span lang="EN-US">ServiceManager</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">中的信息</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>binder_acquire(bs, ptr);//</span>这个吗。当这个<span lang="EN-US">Service</span>退出后，我希望系统通知我一下，好释放上面<span lang="EN-US">malloc</span>出来的资源。大概就是干这个事情的。</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>binder_link_to_death(bs, ptr,
&amp;si-&gt;death);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>return 0;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">喔，对于</span><span lang="EN-US">addService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">来说，看来</span><span lang="EN-US">ServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">把信息加入到自己维护的一个服务列表中了。</span></p>
<h3><span lang="EN-US">2.9 ServiceManager</span>存在的意义</h3>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">为何需要一个这样的东西呢？</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">原来，</span><span lang="EN-US">Android</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">系统中</span><span lang="EN-US">Service</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">信息都是先</span><span lang="EN-US">add</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">到</span><span lang="EN-US">ServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中，由</span><span lang="EN-US">ServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">来集中管理，这样就可以查询当前系统有哪些服务。而且</span><span lang="EN-US">,Android</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">系统中某个服务例如</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的客户端想要和</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">通讯的话，必须先向</span><span lang="EN-US">ServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">查询</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的信息，然后通过</span><span lang="EN-US">ServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">返回的东西再来和</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">交互。</span></p>
<p style="text-indent: 0cm;" class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">毕竟，要是</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">身体不好，老是挂掉的话，客户的代码就麻烦了，就不知道后续新生的</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的信息了，所以只能这样：</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">向</span><span lang="EN-US">SM</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">注册</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">MediaPlayerClient</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">查询当前注册在</span><span lang="EN-US">SM</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中的</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的信息</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">根据这个信息，</span><span lang="EN-US">MediaPlayerClient</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">和</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">交互</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">另外，</span><span lang="EN-US">ServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的</span><span lang="EN-US">handle</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">标示是</span><span lang="EN-US">0</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，所以只要往</span><span lang="EN-US">handle</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">是</span><span lang="EN-US">0</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的服务发送消息了，最终都会被传递到</span><span lang="EN-US">ServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中去。</span></p>
<p class="23"><span style="font-family: 黑体; mso-ascii-font-family: Helvetica;">三</span><span lang="EN-US"> MediaService</span><span style="font-family: 黑体; mso-ascii-font-family: Helvetica;">的运行</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">上一节的知识，我们知道了：</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">defaultServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">得到了</span><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，然后</span><span lang="EN-US">MediaPlayerService </span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">实例化后，调用</span><span lang="EN-US">BpServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的</span><span lang="EN-US">addService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">函数</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">这个过程中，是</span><span lang="EN-US">service_manager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">收到</span><span lang="EN-US">addService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的请求，然后把对应信息放到自己保存的一个服务</span><span lang="EN-US">list</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">到这儿，我们可看到，</span><span lang="EN-US">service_manager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">有一个</span><span lang="EN-US">binder_looper</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">函数，专门等着从</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中接收请求。虽然</span><span lang="EN-US">service_manager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">没有从</span><span lang="EN-US">BnServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中派生，但是它肯定完成了</span><span lang="EN-US">BnServiceManager</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的功能。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">同样，我们创建了</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">即</span><span lang="EN-US">BnMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，那它也应该：</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">打开</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">设备</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">也搞一个</span><span lang="EN-US">looper</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">循环，然后坐等请求</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">service</span>，<span lang="EN-US">service</span>，这个和网络编程中的监听<span lang="EN-US">socket</span>的工作很像嘛！</p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">好吧，既然</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的构造函数没有看到显示的打开</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">设备，那么我们看看它的父类即</span><span lang="EN-US">BnXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">又到底干了些什么呢？</span></p>
<h3><span lang="EN-US">3.1 MediaPlayerService</span>打开<span lang="EN-US">binder</span></h3>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">class
MediaPlayerService : public BnMediaPlayerService</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//
MediaPlayerService</span>从<span lang="EN-US">BnMediaPlayerService</span>派生</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>而<span lang="EN-US">BnMediaPlayerService</span>从<span lang="EN-US">BnInterface</span>和<span lang="EN-US">IMediaPlayerService</span>同时派生</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">class
BnMediaPlayerService: public BnInterface&lt;IMediaPlayerService&gt;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">public:</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>virtual status_t<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>onTransact( uint32_t code,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>const
Parcel&amp; data,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>Parcel*
reply,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>uint32_t flags
= 0);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">};</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">看起来，<span lang="EN-US">BnInterface</span>似乎更加和打开设备相关啊。</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">template&lt;typename
INTERFACE&gt;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">class BnInterface :
public INTERFACE, public BBinder</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">public:</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>virtual sp&lt;IInterface&gt;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>queryLocalInterface(const String16&amp;
_descriptor);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>virtual const String16&amp;<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span>getInterfaceDescriptor() const;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">protected:</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>virtual IBinder*<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>onAsBinder();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">};</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">兑现后变成</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">class BnInterface :
public IMediaPlayerService, public BBinder</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">BBinder?BpBinder</span>？是不是和<span lang="EN-US">BnXXX</span>以及<span lang="EN-US">BpXXX</span>对应的呢？如果是，为什么又叫<span lang="EN-US">BBinder</span>呢？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">BBinder::BBinder()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>: mExtras(NULL)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>没有打开设备的地方啊？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">完了？难道我们走错方向了吗？难道不是每个</span><span lang="EN-US">Service</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">都有对应的</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">设备</span><span lang="EN-US">fd</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">吗？</span></p>
<p class="MsoNormal"><span lang="EN-US">.......</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">回想下，我们的</span><span lang="EN-US">Main_MediaService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">程序，有哪里打开过</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">吗？</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">int main(int argc,
char** argv)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">对啊，我在<span lang="EN-US">ProcessState</span>中不是打开过<span lang="EN-US">binder</span>了吗？<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sp&lt;ProcessState&gt; proc(ProcessState::self());</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sp&lt;IServiceManager&gt; sm =
defaultServiceManager();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">MediaPlayerService::instantiate();<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 1;"> </span><span style="mso-spacerun: yes;">&nbsp; </span>......</span></p>
</div>
<h3><span lang="EN-US">3.2 looper<span style="mso-spacerun: yes;">&nbsp;&nbsp; </span></span></h3>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">啊</span><span lang="EN-US">?</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">原来打开</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">设备的地方是和进程相关的啊？一个进程打开一个就可以了。那么，我在哪里进行类似的消息循环</span><span lang="EN-US">looper</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">操作呢？</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">...</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>难道是下面两个？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; mso-char-indent-count: 2.0; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">ProcessState::self()-&gt;startThreadPool();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">IPCThreadState::self()-&gt;joinThreadPool();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">看看<span lang="EN-US">startThreadPool</span>吧<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">void
ProcessState::startThreadPool()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 1;">&nbsp; </span>...</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>spawnPooledThread(true);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">void
ProcessState::spawnPooledThread(bool isMain)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sp&lt;Thread&gt; t = new
PoolThread(isMain);isMain</span>是<span lang="EN-US">TRUE</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">创建线程池，然后<span lang="EN-US">run</span>起来，和<span lang="EN-US">java</span>的<span lang="EN-US">Thread</span>何其像也。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>t-&gt;run(buf);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;</span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">PoolThread</span><span style="color: red;">从<span lang="EN-US">Thread</span>类中派生，那么此时会产生一个线程吗？看看<span lang="EN-US">PoolThread</span>和<span lang="EN-US">Thread</span>的构造吧<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">PoolThread::PoolThread(bool
isMain)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>: mIsMain(isMain)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">Thread::Thread(bool
canCallJava)//canCallJava</span>默认值是<span lang="EN-US">true</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>:<span style="mso-spacerun: yes;">&nbsp;&nbsp;
</span>mCanCallJava(canCallJava),</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>mThread(thread_id_t(-1)),</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>mLock("Thread::mLock"),</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>mStatus(NO_ERROR),</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>mExitPending(false), mRunning(false)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">喔，这个时候还没有创建线程呢。然后调用<span lang="EN-US">PoolThread::run</span>，实际调用了基类的<span lang="EN-US">run</span>。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">status_t
Thread::run(const char* name, int32_t priority, size_t stack)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span>bool res;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>if (mCanCallJava) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>res = createThreadEtc(_threadLoop,//</span>线程函数是<span lang="EN-US">_threadLoop</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>this, name, priority, stack,
&amp;mThread);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>} </span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; mso-char-indent-count: 2.0; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">终于，在<span lang="EN-US">run</span>函数中，创建线程了。从此<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; mso-char-indent-count: 2.0; background: #D9D9D9;" class="GB23121471"><span style="color: red;">主线程执行<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">IPCThreadState::self()-&gt;joinThreadPool();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">新开的线程执行<span lang="EN-US">_threadLoop<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">我们先看看<span lang="EN-US">_threadLoop<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">int
Thread::_threadLoop(void* user)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>Thread* const self =
static_cast&lt;Thread*&gt;(user);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sp&lt;Thread&gt;
strong(self-&gt;mHoldSelf);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>wp&lt;Thread&gt; weak(strong);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>self-&gt;mHoldSelf.clear();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>do {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;</span>...</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (result &amp;&amp; !self-&gt;mExitPending)
{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>result = self-&gt;threadLoop();</span>哇塞，调用自己的<span lang="EN-US">threadLoop</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>} </span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">我们是<span lang="EN-US">PoolThread</span>对象，所以调用<span lang="EN-US">PoolThread</span>的<span lang="EN-US">threadLoop</span>函数<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">virtual
bool PoolThread ::threadLoop()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//mIsMain</span>为<span lang="EN-US">true</span>。 </p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>而且注意，这是一个新的线程，所以必然会创建一个</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471">新的<span lang="EN-US">IPCThreadState</span>对象（记得线程本地存储吗？<span lang="EN-US">TLS</span>），然后<span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">IPCThreadState::self()-&gt;joinThreadPool(mIsMain);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return false;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">主线程和工作线程都调用了<span lang="EN-US">joinThreadPool</span>，看看这个干嘛了！<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">void
IPCThreadState::joinThreadPool(bool isMain)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span>mOut.writeInt32(isMain ? BC_ENTER_LOOPER :
BC_REGISTER_LOOPER);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;</span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>status_t result;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>do {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>int32_t cmd;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>result = talkWithDriver();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;</span>result = executeCommand(cmd);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>} while (result != -ECONNREFUSED
&amp;&amp; result != -EBADF);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>mOut.writeInt32(BC_EXIT_LOOPER);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>talkWithDriver(false);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">看到没？有<span lang="EN-US">loop</span>了，但是好像是有两个线程都执行了这个啊！这里有两个消息循环？<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">下面看看<span lang="EN-US">executeCommand<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">status_t
IPCThreadState::executeCommand(int32_t cmd)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">BBinder*
obj;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>RefBase::weakref_type* refs;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>status_t result = NO_ERROR;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">case
BR_TRANSACTION:</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>binder_transaction_data tr;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>result = mIn.read(&amp;tr,
sizeof(tr));</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">来了一个命令，解析成<span lang="EN-US">BR_TRANSACTION,</span>然后读取后续的信息<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Parcel reply;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (tr.target.ptr) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">这里用的是<span lang="EN-US">BBinder</span>。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sp&lt;BBinder&gt;
b((BBinder*)tr.cookie);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>const status_t error =
b-&gt;transact(tr.code, buffer, &amp;reply, 0);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">让我们看看<span lang="EN-US">BBinder</span>的<span lang="EN-US">transact</span>函数干嘛了<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">status_t
BBinder::transact(</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>uint32_t code, const Parcel&amp; data,
Parcel* reply, uint32_t flags)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span style="color: red;">就是调用自己的<span lang="EN-US">onTransact</span>函数嘛<span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">err
= onTransact(code, data, reply, flags);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>return err;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span lang="EN-US">BnMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">从</span><span lang="EN-US">BBinder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">派生，所以会调用到它的</span><span lang="EN-US">onTransact</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">函数</span><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span></span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">终于水落石出了，让我们看看</span><span lang="EN-US">BnMediaPlayerServcice</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的</span><span lang="EN-US">onTransact</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">函数。</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">status_t
BnMediaPlayerService::onTransact(</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>uint32_t code, const Parcel&amp; data,
Parcel* reply, uint32_t flags)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//
BnMediaPlayerService</span><span style="color: red;">从<span lang="EN-US">BBinder</span>和<span lang="EN-US">IMediaPlayerService</span>派生，所有<span lang="EN-US">IMediaPlayerService<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">看到下面的<span lang="EN-US">switch</span>没？所有<span lang="EN-US">IMediaPlayerService</span>提供的函数都通过命令类型来区分<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//<o:p></o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>switch(code) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>case CREATE_URL: {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>CHECK_INTERFACE(IMediaPlayerService, data, reply);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="color: red;" lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;</span>create</span><span style="color: red;">是一个虚函数，由<span lang="EN-US">MediaPlayerService</span>来实现！！<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 60.3pt; mso-char-indent-count: 6.7; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">sp&lt;IMediaPlayer&gt; player = create(</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pid, client, url,
numHeaders &gt; 0 ? &amp;headers : NULL);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>reply-&gt;writeStrongBinder(player-&gt;asBinder());</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return NO_ERROR;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>} break;</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">其实，到这里，我们就明白了。</span><span lang="EN-US">BnXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的</span><span lang="EN-US">onTransact</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">函数收取命令，然后派发到派生类的函数，由他们完成实际的工作。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">说明：</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">这里有点特殊，</span><span lang="EN-US">startThreadPool</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">和</span><span lang="EN-US">joinThreadPool</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">完后确实有两个线程，主线程和工作线程，而且都在做消息循环。为什么要这么做呢？他们参数</span><span lang="EN-US">isMain</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">都是</span><span lang="EN-US">true</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。不知道</span><span lang="EN-US">google</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">搞什么。难道是怕一个线程工作量太多，所以搞两个线程来工作？这种解释应该也是合理的。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">网上有人测试过把最后一句屏蔽掉，也能正常工作。但是难道主线程提出了，程序还能不退出吗？这个</span><span lang="EN-US">...</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">管它的，反正知道有两个线程在那处理就行了。</span></p>
<p class="23"><span style="font-family: 黑体; mso-ascii-font-family: Helvetica;">四</span><span lang="EN-US"> MediaPlayerClient</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">这节讲讲</span><span lang="EN-US">MediaPlayerClient</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">怎么和</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">交互。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">使用</span><span lang="EN-US">MediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的时候，先要创建它的</span><span lang="EN-US">BpMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。我们看看一个例子</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">IMediaDeathNotifier::getMediaPlayerService()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sp&lt;IServiceManager&gt; sm =
defaultServiceManager();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sp&lt;IBinder&gt; binder;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>do {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>向<span lang="EN-US">SM</span>查询对应服务的信息，返回<span lang="EN-US">binder<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">binder =
sm-&gt;getService(String16("media.player"));</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (binder != 0) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>break;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>usleep(500000); // 0.5 s</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>} while(true);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">通过<span lang="EN-US">interface_cast</span>，将这个<span lang="EN-US">binder</span>转化成<span lang="EN-US">BpMediaPlayerService<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">注意，这个<span lang="EN-US">binder</span>只是用来和<span lang="EN-US">binder</span>设备通讯用的，实际<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">上和<span lang="EN-US">IMediaPlayerService</span>的功能一点关系都没有。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">还记得我说的<span lang="EN-US">Bridge</span>模式吗<span lang="EN-US">?BpMediaPlayerService</span>用这个<span lang="EN-US">binder</span>和<span lang="EN-US">BnMediaPlayerService<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">通讯。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>sMediaPlayerService =
interface_cast&lt;IMediaPlayerService&gt;(binder);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>return sMediaPlayerService;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">为什么反复强调这个</span><span lang="EN-US">Bridge</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">？其实也不一定是</span><span lang="EN-US">Bridge</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">模式，但是我真正想说明的是：</span></p>
<p class="MsoNormal"><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">其实就是一个和</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">设备打交道的接口，而上层</span><span lang="EN-US">IMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">只不过把它当做一个类似</span><span lang="EN-US">socket</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">使用罢了。我以前经常把</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">和上层类</span><span lang="EN-US">IMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的功能混到一起去。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">当然，你们不一定会犯这个错误。但是有一点请注意：</span></p>
<h3><span lang="EN-US">4.1 Native</span>层</h3>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">刚才那个</span><span lang="EN-US">getMediaPlayerService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">代码是</span><span lang="EN-US">C++</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">层的，但是整个使用的例子确实</span><span lang="EN-US">JAVA-&gt;JNI</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">层的调用。如果我要写一个纯</span><span lang="EN-US">C++</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的程序该怎么办？</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">int main()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span>getMediaPlayerService();</span><span style="color: red;">直接调用这个函数能获得<span lang="EN-US">BpMediaPlayerService</span>吗？<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;">不能，为什么？因为我还没打开<span lang="EN-US">binder</span>驱动呐！但是你在<span lang="EN-US">JAVA</span>应用程序里边却有<span lang="EN-US">google</span>已经替你<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;">封装好了。<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;">所以，纯<span lang="EN-US">native</span>层的代码，必须也得像下面这样处理：<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">sp&lt;ProcessState&gt;
proc(ProcessState::self());</span><span style="color: red;" lang="EN-US">//</span><span style="color: red;">这个其实不是必须的，因为<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">好多地方都需要这个，所以自动也会创建<span lang="EN-US">.<o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">getMediaPlayerService();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;">还得起消息循环呐，否则如果<span lang="EN-US">Bn</span>那边有消息通知你，你怎么接受得到呢？<span lang="EN-US"><o:p></o:p></span></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">ProcessState::self()-&gt;startThreadPool();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span style="color: red;" lang="EN-US">//</span><span style="color: red;">至于主线程是否也需要调用消息循环，就看个人而定了。不过一般是等着接收其他来源的消息，例如<span lang="EN-US">socket</span>发来的命令，然后控制<span lang="EN-US">MediaPlayerService</span>就可以了</span>。</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
</div>
<p class="MsoNormal"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p class="23"><span style="font-family: 黑体; mso-ascii-font-family: Helvetica;">五</span>
<span style="font-family: 黑体; mso-ascii-font-family: Helvetica;">实现自己的</span><span lang="EN-US">Service</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">好了，我们学习了这么多</span><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的东西，那么想要实现一个自己的</span><span lang="EN-US">Service</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">该咋办呢？</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">如果是纯</span><span lang="EN-US">C++</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">程序的话，肯定得类似</span><span lang="EN-US">main_MediaService</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">那样干了。</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">int main()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span>sp&lt;ProcessState&gt;
proc(ProcessState::self());</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">sp&lt;IServiceManager&gt;
sm = defaultServiceManager();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">sm-&gt;addService(“service.name”,new
XXXService());</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">ProcessState::self()-&gt;startThreadPool();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">IPCThreadState::self()-&gt;joinThreadPool();</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">看看<span lang="EN-US">XXXService</span>怎么定义呢？</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">我们需要一个<span lang="EN-US">Bn</span>，需要一个<span lang="EN-US">Bp</span>，而且<span lang="EN-US">Bp</span>不用暴露出来。那么就在<span lang="EN-US">BnXXX.cpp</span>中一起实现好了。</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">另外，<span lang="EN-US">XXXService</span>提供自己的功能，例如<span lang="EN-US">getXXX</span>调用</p>
</div>
<h3><span lang="EN-US">5.1 </span>定义<span lang="EN-US">XXX</span>接口</h3>
<p class="MsoNormal"><span lang="EN-US">XXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">接口是和</span><span lang="EN-US">XXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">服务相关的，例如提供</span><span lang="EN-US">getXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，</span><span lang="EN-US">setXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">函数，和应用逻辑相关。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">需要从</span><span lang="EN-US">IInterface</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">派生</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">class IXXX: public
IInterface</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 1;"> </span>public:</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">DECLARE_META_INTERFACE(XXX);</span>申明宏</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">virtual
getXXX() = 0;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">virtual
setXXX() = 0;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span>这是一个接口。</p>
</div>
<h3><span lang="EN-US">5.2 </span>定义<span lang="EN-US">BnXXX</span>和<span lang="EN-US">BpXXX</span></h3>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">为了把</span><span lang="EN-US">IXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">加入到</span><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">结构，需要定义</span><span lang="EN-US">BnXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">和对客户端透明的</span><span lang="EN-US">BpXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">其中</span><span lang="EN-US">BnXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">是需要有头文件的。</span><span lang="EN-US">BnXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">只不过是把</span><span lang="EN-US">IXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">接口加入到</span><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">架构中来，而不参与实际的</span><span lang="EN-US">getXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">和</span><span lang="EN-US">setXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">应用层逻辑。</span></p>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">这个</span><span lang="EN-US">BnXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">定义可以和上面的</span><span lang="EN-US">IXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">定义放在一块。分开也行。</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">class BnXXX: public
BnInterface&lt;IXXX&gt;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">public:</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>virtual status_t<span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>onTransact( uint32_t code,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>const
Parcel&amp; data,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>Parcel*
reply,</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 </span>uint32_t
flags = 0);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//</span>由于<span lang="EN-US">IXXX</span>是个纯虚类，而<span lang="EN-US">BnXXX</span>只实现了<span lang="EN-US">onTransact</span>函数，所以<span lang="EN-US">BnXXX</span>依然是</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471">一个纯虚类</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">};</span></p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">有了</span><span lang="EN-US">DECLARE</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">，那我们在某个</span><span lang="EN-US">CPP</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中</span><span lang="EN-US">IMPLEMNT</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">它吧。那就在</span><span lang="EN-US">IXXX.cpp</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">中吧。</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">IMPLEMENT_META_INTERFACE(XXX,
"android.xxx.IXXX");//IMPLEMENT</span>宏</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">status_t BnXXX::onTransact(</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>uint32_t code, const Parcel&amp; data,
Parcel* reply, uint32_t flags)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>switch(code) {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>case GET_XXX: {</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>CHECK_INTERFACE(IXXX, data, reply);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span>读请求参数</p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 3;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span>调用虚函数<span lang="EN-US">getXXX()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return NO_ERROR;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>} break; //SET_XXX</span>类似</p>
</div>
<p class="MsoNormal"><span lang="EN-US">BpXXX</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">也在这里实现吧。</span></p>
<div style="mso-element: para-border-div; border: solid windowtext 1.0pt; mso-border-alt: solid windowtext .5pt; padding: 1.0pt 4.0pt 1.0pt 4.0pt; background: #D9D9D9; margin-left: 14.7pt; margin-right: 10.0pt;">
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">class BpXXX: public
BpInterface&lt;IXXX&gt;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">public:</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span><span style="mso-spacerun: yes;">&nbsp;&nbsp;</span>BpXXX
(const sp&lt;IBinder&gt;&amp; impl)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>: BpInterface&lt; IXXX &gt;(impl)</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">vitural
getXXX()</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">{</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-tab-count: 1;">&nbsp; </span>Parcel data, reply;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp; </span>data.writeInterfaceToken(IXXX::getInterfaceDescriptor());</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>data.writeInt32(pid);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>remote()-&gt;transact(GET_XXX, data,
&amp;reply);</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US"><span style="mso-spacerun: yes;">&nbsp;&nbsp; </span>return;</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">}</span></p>
<p style="margin-top: 6.0pt; margin-right: 0cm; margin-bottom: 6.0pt; margin-left: 0cm; text-indent: 18.0pt; background: #D9D9D9;" class="GB23121471"><span lang="EN-US">//setXXX</span>类似</p>
</div>
<p class="MsoNormal"><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">至此，</span><span lang="EN-US">Binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">就算分析完了，大家看完后，应该能做到以下几点：</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">如果需要写自己的</span><span lang="EN-US">Service</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的话，总得知道系统是怎么个调用你的函数，恩。对。有</span><span lang="EN-US">2</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">个线程在那不停得从</span><span lang="EN-US">binder</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">设备中收取命令，然后调用你的函数呢。恩，这是个多线程问题。</span></p>
<p class="-"><!--[if !supportLists]--><span style="font-family: Wingdings; mso-fareast-font-family: Wingdings; mso-bidi-font-family: Wingdings;" lang="EN-US"><span style="mso-list: Ignore;">l<span style="font: 7.0pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">如果需要跟踪</span><span lang="EN-US">bug</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">的话，得知道从</span><span lang="EN-US">Client</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">端调用的函数，是怎么最终传到到远端的</span><span lang="EN-US">Service</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">。这样，对于一些函数调用，</span><span lang="EN-US">Client</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">端跟踪完了，我就知道转到</span><span lang="EN-US">Service</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">去看对应函数调用了。反正是同步方式。也就是</span><span lang="EN-US">Client</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">一个函数调用会一直等待到</span><span lang="EN-US">Service</span><span style="font-family: 汉仪书宋二简; mso-ascii-font-family: &quot;Times New Roman&quot;;">返回为止。</span></p>
<p class="MsoNormal"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>
<p></p></div><div id="MySignature">谢谢大家对《深入理解android 卷I/卷II》的支持。</div>
<script type="text/javascript">
var isLogined = false;
var cb_blogId = 82270;
var cb_entryId = 1931456;
var cb_blogApp = currentBlogApp;
var cb_blogUserGuid = "de1c1283-921b-e011-ac81-842b2b196315";
var cb_entryCreatedDate = '2011/1/9 21:28:00';
var enableGoogleAd = true;
var googletag = googletag || {};
googletag.cmd = googletag.cmd || [];
</script>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="blog_post_info"><div id="BlogPostCategory">分类: <a href="http://www.cnblogs.com/innost/category/279110.html">Android 深入浅出</a></div>
<div id="EntryTag"></div>
<div id="green_channel">
绿色通道：
<a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(cb_entryId,cb_blogId,1);green_channel_success(this,'谢谢推荐！');">好文要顶</a>
<a id="green_channel_follow" onclick="c_follow();" href="javascript:void(0);">关注我</a>
<a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a><a id="green_channel_contact" href="http://space.cnblogs.com/msg/send/innost" target="_blank">与我联系</a>
<a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="1931456_files/icon_weibo_24.png" alt=""></a>
</div>
<div id="digg_block">
<div id="author_profile">
<div id="author_profile_info" class="author_profile_info">
<div id="author_profile_detail" class="author_profile_info">
<a href="http://home.cnblogs.com/u/innost/">innost</a><br>
<a href="http://home.cnblogs.com/u/innost/followees">关注 - 5</a><br>
<a href="http://home.cnblogs.com/u/innost/followers">粉丝 - 147</a>
</div>
</div>
<div class="clear"></div>
<div id="author_profile_honor"></div>
<div id="author_profile_follow">
<a href="javascript:void(0);" onclick="c_follow();return false;">+加关注</a>
</div>
</div>
<div id="div_digg">										
	<div class="diggit" onclick="votePost(cb_entryId,'Digg')"> 
		<span class="diggnum" id="digg_count">9</span>
	</div>
	<div class="buryit" onclick="votePost(cb_entryId,'Bury')"> 
		<span class="burynum" id="bury_count">0</span>
	</div>
	<div class="clear"></div>	
	<div class="diggword" id="digg_tips">
    (请您对文章做出评价)
    </div>	
</div>
</div></div>
<div class="clear"></div>
<div id="post_next_prev"><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931457.html" class="p_n_p_prefix">» </a> 博主下一篇：<a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931457.html" title="发布于2011-01-09 21:29">Android深入浅出之Audio 第一部分 AudioTrack分析</a><br></div>
</div>
<script type="text/javascript">
    //SyntaxHighlighter.config.strings.expandSource = '<span><img src="http://static.cnblogs.com/images/expand-code.gif" alt="" class="expand-code-icon"/>View Code</span>';
    $(function () {             
        fixPostBodyFormat();
        loadAdUnderPost();
        loadBlogSignature();
        LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
        GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate);        
        GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);        
    });
</script>
		</div>
		<div class="postDesc">posted @ <span id="post-date">2011-01-09 21:28</span> <a href="http://www.cnblogs.com/innost/">innost</a> 阅读(64910) 评论(<span id="post-comment-count">112</span>)  <a href="http://www.cnblogs.com/innost/admin/EditPosts.aspx?postid=1931456" rel="nofollow">编辑</a> <a href="#" onclick="AddToWz(1931456);return false;">收藏</a></div>
	</div>
	<img src="1931456_files/1931456.jpeg" alt="" height="1" width="1">
	
</div><!--end: topics 文章、评论容器-->
<div id="blog-comments-placeholder"><div id="comments_pager_top"><div class="pager"><a href="javascript:void(0);" onclick="commentManager.loadPagedComments(false,2,50);return false;">&lt; Prev</a><a href="javascript:void(0);" onclick="commentManager.loadPagedComments(false,1,50);return false;">1</a><a href="javascript:void(0);" onclick="commentManager.loadPagedComments(false,2,50);return false;">2</a><span class="current">3</span></div></div>
<!--done-->
<div class="feedback_area_title">评论列表</div>
<div class="feedbackNoItems"></div>
	

		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2395019" class="layer">#63楼</a><a name="2395019" id="comment_anchor_2395019"></a>  <span class="comment_date">2012-06-07 10:39</span> <a id="a_comment_author_2395019" href="http://www.cnblogs.com/xfantasy/" target="_blank">猪小生</a> <a href="http://space.cnblogs.com/msg/send/%e7%8c%aa%e5%b0%8f%e7%94%9f" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2395019" class="blog_comment_body">@楼主：<br>native service和android service除了前者是通过init.rc启动，后者是在第二阶段启动 还有什么区别吗？</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2395019,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2395019,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2395058" class="layer">#64楼</a><a name="2395058" id="comment_anchor_2395058"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-06-07 11:15</span> <a id="a_comment_author_2395058" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2395058" class="blog_comment_body"><a href="#2395019" title="查看所回复的评论">@</a>猪小生<br><fieldset class="comment_quote"><legend><a href="#2395019" title="查看引用原文">引用</a></legend>@楼主：<br>native service和android service除了前者是通过init.rc启动，后者是在第二阶段启动 还有什么区别吗？</fieldset><br><br>不能这么去看啊。这和启动顺序没有关系。这是两个层次的东西，虽然都是service，虽然都是aidl。<br>native service：就是linux的进程<br>android service：运行在android环境中的。当然底层都是用binder进行通信。<br>为何要区分他们的区别？我个人感觉这些东西 能意会的内容比能言传的要多点</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2395058,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2395058,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2396400" class="layer">#65楼</a><a name="2396400" id="comment_anchor_2396400"></a>  <span class="comment_date">2012-06-08 16:51</span> <a id="a_comment_author_2396400" href="http://home.cnblogs.com/u/412627/" target="_blank">ljq1000</a> <a href="http://space.cnblogs.com/msg/send/ljq1000" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2396400" class="blog_comment_body">楼主好！在您的博园上没找到提问的地方，就借这个地方用用吧。<br>最近正在阅读您的大作，关于wp/sp的那部分我有两个问题：wp存在的意义是什么？轻量级的引用计数类我明白，我自己也实现过，我是不是可以理解为轻量级的引用计数类就是实现的sp的功能？</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2396400,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2396400,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2396415" class="layer">#66楼</a><a name="2396415" id="comment_anchor_2396415"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-06-08 17:05</span> <a id="a_comment_author_2396415" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2396415" class="blog_comment_body"><a href="#2396400" title="查看所回复的评论">@</a>ljq1000<br><fieldset class="comment_quote"><legend><a href="#2396400" title="查看引用原文">引用</a></legend>楼主好！在您的博园上没找到提问的地方，就借这个地方用用吧。<br>最近正在阅读您的大作，关于wp/sp的那部分我有两个问题：wp存在的意义是什么？轻量级的引用计数类我明白，我自己也实现过，我是不是可以理解为轻量级的引用计数类就是实现的sp的功能？</fieldset><br>我
在C++中从来没用过这个wp。这是设计上的问题。原因未知，反正肯定是跟内存回收有关系。因为google并没有给出一个指导，告诉我们什么时候用
wp，什么时候用sp。所以这个东西，很难解释。就把它看做java中的weak引用吧。《==java这个，你清楚么？呵呵</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2396415,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2396415,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2413236" class="layer">#67楼</a><a name="2413236" id="comment_anchor_2413236"></a>  <span class="comment_date">2012-07-03 10:23</span> <a id="a_comment_author_2413236" href="http://home.cnblogs.com/u/423876/" target="_blank">felt</a> <a href="http://space.cnblogs.com/msg/send/felt" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2413236" class="blog_comment_body">写得挺好的,提个疑问吧,binder是提供了跨进程调用的手段,这个跨进程调用是怎么实现的?也就是说client端怎么寻址到server端的内存的?进程空间映射到内核空间再隐射出来?</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2413236,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2413236,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2413308" class="layer">#68楼</a><a name="2413308" id="comment_anchor_2413308"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-07-03 10:35</span> <a id="a_comment_author_2413308" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2413308" class="blog_comment_body"><a href="#2413236" title="查看所回复的评论">@</a>felt<br>有binder驱动在内核空间帮忙，怕什么？原理巨简单...<br>如果不清楚，您还怕得研究下linux内核方面的知识了..</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2413308,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2413308,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2423459" class="layer">#69楼</a><a name="2423459" id="comment_anchor_2423459"></a>  <span class="comment_date">2012-07-10 14:18</span> <a id="a_comment_author_2423459" href="http://home.cnblogs.com/u/423337/" target="_blank">zhongyuanceshi</a> <a href="http://space.cnblogs.com/msg/send/zhongyuanceshi" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2423459" class="blog_comment_body">楼主太牛了，看了两遍还是稀里糊涂，知道个大概，怎么应用，不会</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2423459,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2423459,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2426232" class="layer">#70楼</a><a name="2426232" id="comment_anchor_2426232"></a>  <span class="comment_date">2012-07-13 16:15</span> <a id="a_comment_author_2426232" href="http://home.cnblogs.com/u/427326/" target="_blank">laimingj</a> <a href="http://space.cnblogs.com/msg/send/laimingj" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2426232" class="blog_comment_body">楼主，你好，先问两个比较初级的问题：<br>1、是不是所有的应用程序在调用sp&lt;ProcessState&gt; proc(ProcessState::self());函数时都会打开 /dev/binder设备？<br>2、binder是一个虚拟的设备，那么系统中仅存在一个binder还是存在多个binder？<br>3、如果是仅存在一个binder那么上面1中如果多个程序去执行int fd = open("/dev/binder", O_RDWR);//打开/dev/binder操作会不会有问题？<br><br>谢谢！</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2426232,'Digg',this)">支持(2)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2426232,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2426459" class="layer">#71楼</a><a name="2426459" id="comment_anchor_2426459"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-07-13 22:23</span> <a id="a_comment_author_2426459" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2426459" class="blog_comment_body"><a href="#2426232" title="查看所回复的评论">@</a>laimingj<br>小伙，你这个问题实在是初级到不行了。建议你把linux编程好好看看吧，苦练内功。这个，靠问几个问题 想得到质的改变，比较困难。加油！<br>BTW，你看完那本书，问题自然得解了。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2426459,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2426459,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2440030" class="layer">#72楼</a><a name="2440030" id="comment_anchor_2440030"></a>  <span class="comment_date">2012-08-02 15:58</span> <a id="a_comment_author_2440030" href="http://home.cnblogs.com/u/433802/" target="_blank">FT逍遥</a> <a href="http://space.cnblogs.com/msg/send/FT%e9%80%8d%e9%81%a5" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2440030" class="blog_comment_body">Ino大神，4.0.3的transact函数好像有变化了咯，调用的是<br>    reply-&gt;writeInt32(pingBinder());<br>            break;<br><br>而没有调用status_t IPCThreadState:transact</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2440030,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2440030,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2445876" class="layer">#73楼</a><a name="2445876" id="comment_anchor_2445876"></a>  <span class="comment_date">2012-08-10 11:08</span> <a id="a_comment_author_2445876" href="http://home.cnblogs.com/u/436227/" target="_blank">cheason</a> <a href="http://space.cnblogs.com/msg/send/cheason" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2445876" class="blog_comment_body">楼主你好，我看完了，有些不太明白。<br>只看到bpServiceManager创建的时候传递的是BpBinder，但是不知道bpServiceManager是如何跟bnServiceManager关联的。<br>我的理解是new bpXXX(remote)时，参数remote是bnXXX（或者其子类），但是这个bpServiceManager传的却是BpBinder。<br>能否指点一下，谢谢。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2445876,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2445876,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2446185" class="layer">#74楼</a><a name="2446185" id="comment_anchor_2446185"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-08-10 16:02</span> <a id="a_comment_author_2446185" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2446185" class="blog_comment_body"><a href="#2445876" title="查看所回复的评论">@</a>cheason<br>小伙，你还是得把整篇文章看看。你提的问题表明你还没有真正区分业务和通信。再看看，多想想。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2446185,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2446185,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2453468" class="layer">#75楼</a><a name="2453468" id="comment_anchor_2453468"></a>  <span class="comment_date">2012-08-22 09:39</span> <a id="a_comment_author_2453468" href="http://www.cnblogs.com/zyymcu/" target="_blank">zyymcu</a> <a href="http://space.cnblogs.com/msg/send/zyymcu" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2453468" class="blog_comment_body">邓老师好，有个问题请教一下，每个进程都要打开binder设备一次，那各个进程之间是怎么保持同步的呢？谢谢。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2453468,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2453468,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2453479" class="layer">#76楼</a><a name="2453479" id="comment_anchor_2453479"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-08-22 09:44</span> <a id="a_comment_author_2453479" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2453479" class="blog_comment_body"><a href="#2453468" title="查看所回复的评论">@</a>zyymcu<br>同不同步和user space有什么关系，binder下面是个驱动，有驱动管着呢。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2453479,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2453479,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2453491" class="layer">#77楼</a><a name="2453491" id="comment_anchor_2453491"></a>  <span class="comment_date">2012-08-22 09:50</span> <a id="a_comment_author_2453491" href="http://www.cnblogs.com/zyymcu/" target="_blank">zyymcu</a> <a href="http://space.cnblogs.com/msg/send/zyymcu" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2453491" class="blog_comment_body"><a href="#2453479" title="查看所回复的评论">@</a>innost<br>老师回答真快啊。也就是说binder设备驱动是进程安全的，用户进程不用担心。。有的驱动不是进程安全的吧？例如我在window上用记事本打开一个文件，然后用notepad++打开同一个文件，两边同时操作，这是不合理的吧。非常感谢老师的回答。:)</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2453491,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2453491,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2453579" class="layer">#78楼</a><a name="2453579" id="comment_anchor_2453579"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-08-22 10:44</span> <a id="a_comment_author_2453579" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2453579" class="blog_comment_body"><a href="#2453491" title="查看所回复的评论">@</a>zyymcu<br>驱动是人写的，安不安全是它的事。他要这么设计，我们也没办法。你为何要纠结这个呢？既然没有出事，那么驱动就做好了同步。知道这个，就完了。不要把你所了解的知识来反证人家是错误的。毕竟，binder工作得好好的，所以，错误的只可能是你的知识了。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2453579,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2453579,'Bury',this)">反对(1)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2453677" class="layer">#79楼</a><a name="2453677" id="comment_anchor_2453677"></a>  <span class="comment_date">2012-08-22 12:28</span> <a id="a_comment_author_2453677" href="http://www.cnblogs.com/zyymcu/" target="_blank">zyymcu</a> <a href="http://space.cnblogs.com/msg/send/zyymcu" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2453677" class="blog_comment_body"><a href="#2453579" title="查看所回复的评论">@</a>innost<br><br>因
为个人觉得学习android并不只是学习怎么编写上层应用程序，怎么在framework层添加一个service如此。。关键是学习其中优秀的设计模
式，例如常见的单例模式，桥接模式等。。正如老师的书中那样理解透彻。正因如此，我想借binder机制学习一下android是如何实现进程通讯的同时
又是如何保证进程同步的。。大型的程序肯定用的上。在以后的开发中(并不只是android开发)可以学习其先进的机制，甚至照搬。。正所谓：熟读唐诗三
百首不会作诗也会偷。再次感谢。:)</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2453677,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2453677,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2459090" class="layer">#80楼</a><a name="2459090" id="comment_anchor_2459090"></a>  <span class="comment_date">2012-08-29 15:34</span> <a id="a_comment_author_2459090" href="http://home.cnblogs.com/u/442357/" target="_blank">cnblogsfld</a> <a href="http://space.cnblogs.com/msg/send/cnblogsfld" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2459090" class="blog_comment_body">这就是一个进程外COM</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2459090,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2459090,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2466012" class="layer">#81楼</a><a name="2466012" id="comment_anchor_2466012"></a>  <span class="comment_date">2012-09-06 18:20</span> <a id="a_comment_author_2466012" href="http://www.cnblogs.com/jacky-liu/" target="_blank">Jacky Liu</a> <a href="http://space.cnblogs.com/msg/send/Jacky+Liu" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2466012" class="blog_comment_body"><a href="http://pic002.cnblogs.com/images/2012/344056/2012090618175826.jpg" target="_blank"><img src="1931456_files/2012090618175826.jpg" alt="" onload="javascript:if(this.width>500) this.width=500;" border="0" width="500"></a><br>各位前辈，在这个图中，每个SERVER都会在BINDER中对应一个实体么？（除了匿名BINDER）</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2466012,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2466012,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2466058" class="layer">#82楼</a><a name="2466058" id="comment_anchor_2466058"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-09-06 20:23</span> <a id="a_comment_author_2466058" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2466058" class="blog_comment_body"><a href="#2466012" title="查看所回复的评论">@</a>Jacky Liu<br>是的。呵呵</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2466058,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2466058,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2466254" class="layer">#83楼</a><a name="2466254" id="comment_anchor_2466254"></a>  <span class="comment_date">2012-09-07 09:06</span> <a id="a_comment_author_2466254" href="http://www.cnblogs.com/jacky-liu/" target="_blank">Jacky Liu</a> <a href="http://space.cnblogs.com/msg/send/Jacky+Liu" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2466254" class="blog_comment_body"><a href="#2466058" title="查看所回复的评论">@</a>innost<br>邓
老师，这个点是不是这么个意思呢：serveA内有一个BINDER实体(其实就是serveA自己的实体，继承自BINDER，此处强制转为
BINDER父类，目的多态)，然后在内核内又有一个BINDER实体（这个实体是驱动层的实际BINDER实体，他的内容是serveA的引用）？还
有，这个实体可以认为是对象吧？</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2466254,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2466254,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2466263" class="layer">#84楼</a><a name="2466263" id="comment_anchor_2466263"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-09-07 09:12</span> <a id="a_comment_author_2466263" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2466263" class="blog_comment_body"><a href="#2466254" title="查看所回复的评论">@</a>Jacky Liu<br>差不多。你自己再把类图和派生关系画下，你就明白了。后续无需再问 呵呵 加油 要自己画！</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2466263,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2466263,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2466978" class="layer">#85楼</a><a name="2466978" id="comment_anchor_2466978"></a>  <span class="comment_date">2012-09-07 17:59</span> <a id="a_comment_author_2466978" href="http://home.cnblogs.com/u/444177/" target="_blank">ycchang</a> <a href="http://space.cnblogs.com/msg/send/ycchang" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2466978" class="blog_comment_body">看了一下午终于搞明白了。<br>补充一点，在通过Binder调用远程对象时候，经常有类似这样的代码<br>remote()-&gt;transact(CREATE_MEDIA_RECORDER, data, &amp;reply);<br>return interface_cast&lt;IMediaRecorder&gt;(reply.readStrongBinder());<br>通过interface_cast会生成一个BpXXX的本地对象，而传进去的参数就是上面的 reply.readStrongBinder()，存储为mRemote。<br>那这个replay.readStrongBinder到底返回的是什么呢？应该是个BpBinder吧，不然怎么调用transact序列化了。果然在Parcel.cpp中有下面的代码<br>case BINDER_TYPE_HANDLE:       <br>  *out = proc-&gt;getStrongProxyForHandle(flat-&gt;handle);<br>  return finish_unflatten_binder(<br>     static_cast&lt;BpBinder*&gt;(out-&gt;get()), *flat, in);<br>原来和getContextObject一样调用了getStrongProxyForHandle。<br>看来是每个远程引用的对象都有一个BpBinder，对吧？</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2466978,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2466978,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2467068" class="layer">#86楼</a><a name="2467068" id="comment_anchor_2467068"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-09-07 21:31</span> <a id="a_comment_author_2467068" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2467068" class="blog_comment_body"><a href="#2466978" title="查看所回复的评论">@</a>ycchang<br>恩。比较忙 才看到 sorry</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2467068,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2467068,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2469090" class="layer">#87楼</a><a name="2469090" id="comment_anchor_2469090"></a>  <span class="comment_date">2012-09-10 22:18</span> <a id="a_comment_author_2469090" href="http://home.cnblogs.com/u/446209/" target="_blank">apt</a> <a href="http://space.cnblogs.com/msg/send/apt" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2469090" class="blog_comment_body"><a href="#2239763" title="查看所回复的评论">@</a>innost<br>楼主您好，您提到，四大组件的service和binder中的service不是同一个概念。<br>但是我觉得：四大组件的android.app.Service和注册到ServiceManager的service都可以跨进程调用，都可以使用aidl，都有Binder的概念，内部的机制应该是一样的。还望楼主指教</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2469090,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2469090,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2469182" class="layer">#88楼</a><a name="2469182" id="comment_anchor_2469182"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-09-11 06:48</span> <a id="a_comment_author_2469182" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2469182" class="blog_comment_body"><a href="#2469090" title="查看所回复的评论">@</a>apt<br>我
说的是activity，service的service。谁说service可以跨进程调用了？只有输出onBind函数的那个才可以。binder是
跨进程调用机制，service是四大组件。你这个概念完全混淆了。一时半会是说不清楚了。估计你代码没咋写过哈。多写写，可能就更容易了解。你自己实现
一个四大组件的service。重点观察onbind函数，看里边是怎么做的。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2469182,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2469182,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2470197" class="layer">#89楼</a><a name="2470197" id="comment_anchor_2470197"></a>  <span class="comment_date">2012-09-11 22:10</span> <a id="a_comment_author_2470197" href="http://home.cnblogs.com/u/446209/" target="_blank">apt</a> <a href="http://space.cnblogs.com/msg/send/apt" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2470197" class="blog_comment_body"><a href="#2469182" title="查看所回复的评论">@</a>innost<br>楼
主你好。1. 
四大组件中的service即我说的android.app.Service，当然是可以跨进程调用的。client可以连接到remote的
service，remote的service也可以回调，参见：ApiDemo之RemoteService. 2. 
另一类service,如通过addService注册到ServiceManager的
ActivityManagerService，ConnectivityManagerService等。（不知这是否是您说的binder中的
service?）。<br>我的疑惑是android.app.Service同样利用了binder，为啥不需要注册到ServiceManager呢？楼主说我概念混淆了，但其实两者内部机制都是跨进程的调用，我觉得应该是相通的。还望楼主和大家不吝赐教:)</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2470197,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2470197,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2472963" class="layer">#90楼</a><a name="2472963" id="comment_anchor_2472963"></a>  <span class="comment_date">2012-09-14 14:56</span> <a id="a_comment_author_2472963" href="http://home.cnblogs.com/u/444177/" target="_blank">ycchang</a> <a href="http://space.cnblogs.com/msg/send/ycchang" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2472963" class="blog_comment_body">楼主好，再看Java的ServiceManager的时候有个疑问。<br>有个类ServiceManagerNative居然实现了OnTransact函数，按道理这个类只有静态函数asInterface有用，而且也不会作为远程对象使用，同时又是一个抽象类。那它写成这样有什么意义呢？</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2472963,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2472963,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2473246" class="layer">#91楼</a><a name="2473246" id="comment_anchor_2473246"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-09-14 19:45</span> <a id="a_comment_author_2473246" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2473246" class="blog_comment_body"><a href="#2472963" title="查看所回复的评论">@</a>ycchang<br>没用。放在那，也没人继承。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2473246,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2473246,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2487501" class="layer">#92楼</a><a name="2487501" id="comment_anchor_2487501"></a>  <span class="comment_date">2012-10-06 12:48</span> <a id="a_comment_author_2487501" href="http://home.cnblogs.com/u/423247/" target="_blank">victor0535</a> <a href="http://space.cnblogs.com/msg/send/victor0535" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2487501" class="blog_comment_body"><a href="#2467068" title="查看所回复的评论">@</a>innost<br>有个问题一直没想明白。 类似的interface_cast，<br>interface_cast&lt;IServiceManager&gt;(new Bpbinder)<br><br>宏替换过去后 在其内部是要执行 Bpbinder－&gt;queryLocalInterface(XXX) 这个函数的<br>面Bpbinder这个类没有对其的实现  只有父类的Ibinder里有实现 但父类的实现是 return null<br><br>倒是BnInterface里实现了，但传进去的以不是BnXXX。 应该怎么解释？<br>谢谢！</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2487501,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2487501,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2489338" class="layer">#93楼</a><a name="2489338" id="comment_anchor_2489338"></a>  <span class="comment_date">2012-10-09 16:06</span> <a id="a_comment_author_2489338" href="http://home.cnblogs.com/u/423247/" target="_blank">victor0535</a> <a href="http://space.cnblogs.com/msg/send/victor0535" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2489338" class="blog_comment_body"><a href="#2047709" title="查看所回复的评论">@</a>innost<br><fieldset class="comment_quote"><legend><a href="#2047709" title="查看引用原文">引用</a></legend>@lujunweixu<br>不好意思，我才看到。应该是对应service的handle，这样Bp端发送消息的时候才能有对应的target。不过这中间过程是比较复杂的，包括引用计数等，需要看驱动才能彻底明白。</fieldset><br><br><br>应该是个BpMediaPlayerService对象吧？ 该对象与驱动交互  Bn端接收信息</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2489338,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2489338,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2489449" class="layer">#94楼</a><a name="2489449" id="comment_anchor_2489449"></a>  <span class="comment_date">2012-10-09 17:36</span> <a id="a_comment_author_2489449" href="http://home.cnblogs.com/u/423247/" target="_blank">victor0535</a> <a href="http://space.cnblogs.com/msg/send/victor0535" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2489449" class="blog_comment_body"><a href="#2239763" title="查看所回复的评论">@</a>innost<br><fieldset class="comment_quote"><legend><a href="#2239763" title="查看引用原文">引用</a></legend>@jhondge<br>1 四大组件中的service 也可以实现后台执行呀。<br>四
大组件的service和binder中的service不是同一个概念。虽然都叫service，虽然都在后台执行。所谓的后台就是不带界面嘛。实际上
任何不带UI的工作线程都可以叫后台。四大组件的service是android一个独有的概念。基本上脱离了传统意义上的进程（也就是说android
中，不需要知道进程）<br>而binder中的service是一个类似C/S架构的service，它驻留在一个进程中。<br>没有什么特殊的含义。简单理解的话，就把binder service看成是socket的监听端，而binder客户端则看成是...</fieldset><br><br>老大，上面这哥们儿说得挺玄乎，说实话，不过我怎么感觉像是在玩模拟器呢？  <br>你的答复真得很有风度。另外，我想知道，他真让你免费送他书了？呵呵</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2489449,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2489449,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2489450" class="layer">#95楼</a><a name="2489450" id="comment_anchor_2489450"></a>  <span class="comment_date">2012-10-09 17:36</span> <a id="a_comment_author_2489450" href="http://home.cnblogs.com/u/423247/" target="_blank">victor0535</a> <a href="http://space.cnblogs.com/msg/send/victor0535" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2489450" class="blog_comment_body"><a href="#2239754" title="查看所回复的评论">@</a>innost<br><fieldset class="comment_quote"><legend><a href="#2239754" title="查看引用原文">引用</a></legend>@Hwa<br>wow,you
 have done an amazing job....About the price,I checked several 
book-store,the price at china-pub is the lowest compared with 360buy and
 amazon.But if you need the book so much ,maybe i could send you one for
 free.I have sent you a short msg about my contact-info. Thanks again. 
To be hone...</fieldset><br>老大，上面这哥们儿说得挺玄乎，说实话，不过我怎么感觉像是在玩模拟器呢？ <br>你的答复真得很有风度。另外，我想知道，他真让你免费送他书了？呵呵</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2489450,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2489450,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2489478" class="layer">#96楼</a><a name="2489478" id="comment_anchor_2489478"></a>  <span class="comment_date">2012-10-09 17:57</span> <a id="a_comment_author_2489478" href="http://home.cnblogs.com/u/423247/" target="_blank">victor0535</a> <a href="http://space.cnblogs.com/msg/send/victor0535" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2489478" class="blog_comment_body"><a href="#2319224" title="查看所回复的评论">@</a>innost<br><fieldset class="comment_quote"><legend><a href="#2319224" title="查看引用原文">引用</a></legend>@manc<br>小伙，似乎你还没看懂啊。要透过封装的浮云....<br>getService，返回的不是BBinder，而是BpXXXService<br>中间有个interface_cast宏，做了转换...麻烦你再仔细看看。呵呵 加油</fieldset><br><br>楼
主，应该回答再详细些，不然别人要还可能有误解。getService 内部 ： 先返回 有关service的Bpbinder, 
然后在把这个bpbinder inter_cast成 内含有这个bpbinder的BpXXXservice 
(哪Bpmediaplayerservice)</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2489478,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2489478,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2489487" class="layer">#97楼</a><a name="2489487" id="comment_anchor_2489487"></a>  <span class="comment_date">2012-10-09 18:08</span> <a id="a_comment_author_2489487" href="http://home.cnblogs.com/u/423247/" target="_blank">victor0535</a> <a href="http://space.cnblogs.com/msg/send/victor0535" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2489487" class="blog_comment_body"><a href="#2396415" title="查看所回复的评论">@</a>innost<br><fieldset class="comment_quote"><legend><a href="#2396415" title="查看引用原文">引用</a></legend>@ljq1000<br><fieldset class="comment_quote"><legend>引用</legend>引用楼主好！在您的博园上没找到提问的地方，就借这个地方用用吧。<br>最近正在阅读您的大作，关于wp/sp的那部分我有两个问题：wp存在的意义是什么？轻量级的引用计数类我明白，我自己也实现过，我是不是可以理解为轻量级的引用计数类就是实现的sp的功能？</fieldset><br>我
在C++中从来没用过这个wp。这是设计上的问题。原因未知，反正肯定是跟内存回收有关系。因为google并没有给出一个指导，告诉我们什么时候用
wp，什么时候用sp。所以这个东西，很难解释。就把它看做java中的weak引用吧。《==java这个，你清楚么？呵呵</fieldset><br><br>我看过一种说法   wp的应用场合  用来指向“胖子类” 即占用量比较大，可能随时销毁掉，但是生成又比较容易  这种</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2489487,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2489487,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2489490" class="layer">#98楼</a><a name="2489490" id="comment_anchor_2489490"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-10-09 18:12</span> <a id="a_comment_author_2489490" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2489490" class="blog_comment_body"><a href="#2489450" title="查看所回复的评论">@</a>victor0535<br>小伙，这哥们技术很强。另外，对自己不知道的东西要保持谦虚谨慎的心态，呵呵。他做的东西可不是一般的模拟器，至少我是做不出来 ^_^</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2489490,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2489490,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2489641" class="layer">#99楼</a><a name="2489641" id="comment_anchor_2489641"></a>  <span class="comment_date">2012-10-09 22:49</span> <a id="a_comment_author_2489641" href="http://home.cnblogs.com/u/423247/" target="_blank">victor0535</a> <a href="http://space.cnblogs.com/msg/send/victor0535" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2489641" class="blog_comment_body"><a href="#2489490" title="查看所回复的评论">@</a>innost<br><fieldset class="comment_quote"><legend><a href="#2489490" title="查看引用原文">引用</a></legend>@victor0535<br>小伙，这哥们技术很强。另外，对自己不知道的东西要保持谦虚谨慎的心态，呵呵。他做的东西可不是一般的模拟器，至少我是做不出来 ^_^</fieldset><br><br>嗯  明白  我也没有否定 只是看着像  呵呵</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2489641,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2489641,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2494420" class="layer">#100楼</a><a name="2494420" id="comment_anchor_2494420"></a>  <span class="comment_date">2012-10-16 20:12</span> <a id="a_comment_author_2494420" href="http://www.cnblogs.com/bastard/" target="_blank">Dufresne</a> <a href="http://space.cnblogs.com/msg/send/Dufresne" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2494420" class="blog_comment_body">学习了，Thanks！<br>请教一下：<br>//将binder设备映射到当前进程下<br>mProcess-&gt;mDriverFD = open("/dev/binder", O_RDWR); <br>ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr);<br>这里将数据直接提交给binder，并没有指定是那个进程接收或者接受者是谁；不像socket有指定的地址。<br>进程在循环从binder设备中读取数据时，是打开binder设备从中读取数据，然后解析但是怎么判断数据是发给我的，内部是如何操作的。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2494420,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2494420,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2494424" class="layer">#101楼</a><a name="2494424" id="comment_anchor_2494424"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-10-16 20:15</span> <a id="a_comment_author_2494424" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2494424" class="blog_comment_body"><a href="#2494420" title="查看所回复的评论">@</a>Dufresne<br>bwr是一个结构体，里边包含一块缓冲，缓冲里边再包含传递的数据信息。binder只是类似socket发送数据，但数据内容是有结构的。目标包含在数据中。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2494424,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2494424,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2517844" class="layer">#102楼</a><a name="2517844" id="comment_anchor_2517844"></a>  <span class="comment_date">2012-10-28 09:37</span> <a id="a_comment_author_2517844" href="http://www.cnblogs.com/haiming/" target="_blank">Balancor</a> <a href="http://space.cnblogs.com/msg/send/Balancor" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2517844" class="blog_comment_body">博主您好：作为android的初学者，这篇文章已经阅读了好几遍了。关于c++方面的基础知识也不是很好，幸好遇见的困难都能从网上找到并解决。现在有个地方，一直让我迷惑，就是：<div><div id="highlighter_854814" class="syntaxhighlighter  cpp"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">BpBinder：：transact( uint32_t code, </code><code class="cpp keyword bold">const</code> <code class="cpp plain">Parcel&amp; data, Parcel* reply, uint32_t flags)</code></div></div></td></tr></tbody></table></div></div>方法要求的是四个参数，而在BpServiceManager：：addService()方法内调用<div><div id="highlighter_257252" class="syntaxhighlighter  cpp"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">BpBinder-&gt;transact(ADD_SERVICE_TRANSACTION , data,reply);</code></div></div></td></tr></tbody></table></div></div>时候只传递进去三个变量。这是怎么回事呢？很基础，但也很迷惑。望博主或路过高人能帮忙解答。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2517844,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2517844,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2518069" class="layer">#103楼</a><a name="2518069" id="comment_anchor_2518069"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-10-28 15:03</span> <a id="a_comment_author_2518069" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2518069" class="blog_comment_body"><a href="#2517844" title="查看所回复的评论">@</a>Balancor<br>c++函数的默认参数。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2518069,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2518069,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2582712" class="layer">#104楼</a><a name="2582712" id="comment_anchor_2582712"></a>  <span class="comment_date">2012-12-20 21:20</span> <a id="a_comment_author_2582712" href="http://home.cnblogs.com/u/481812/" target="_blank">giugiu_li</a> <a href="http://space.cnblogs.com/msg/send/giugiu_li" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2582712" class="blog_comment_body"><a href="#2518069" title="查看所回复的评论">@</a>innost<br>请
教一下 我有点疑惑在gDefaultServiceManager 中已经创建了一个BpBiner（0） 这个是 
ServiceManager的代理吧？他和后来的BpServiceManager 建立的代理 在功能上 有什么区别？ 还是说 后者 
可以直接进行addservice等 ， Bpbinder（0）是用来做什么的？ 有点混淆 谢谢！</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2582712,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2582712,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2582742" class="layer">#105楼</a><a name="2582742" id="comment_anchor_2582742"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-12-20 21:51</span> <a id="a_comment_author_2582742" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2582742" class="blog_comment_body"><a href="#2582712" title="查看所回复的评论">@</a>giugiu_li<br>麻烦去看深入理解android卷1第6章binder。解释都在里边。现在每来一个新兄弟，我就得讲一遍。那还写书做什么？呵呵。谢谢理解啊。加油!</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2582742,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2582742,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2582796" class="layer">#106楼</a><a name="2582796" id="comment_anchor_2582796"></a>  <span class="comment_date">2012-12-21 00:04</span> <a id="a_comment_author_2582796" href="http://home.cnblogs.com/u/481812/" target="_blank">giugiu_li</a> <a href="http://space.cnblogs.com/msg/send/giugiu_li" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2582796" class="blog_comment_body"><a href="#2582742" title="查看所回复的评论">@</a>innost<br>好的 非常感谢~</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2582796,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2582796,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2606075" class="layer">#107楼</a><a name="2606075" id="comment_anchor_2606075"></a>  <span class="comment_date">2013-01-23 20:08</span> <a id="a_comment_author_2606075" href="http://home.cnblogs.com/u/491556/" target="_blank">飞天红猪侠</a> <a href="http://space.cnblogs.com/msg/send/%e9%a3%9e%e5%a4%a9%e7%ba%a2%e7%8c%aa%e4%be%a0" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2606075" class="blog_comment_body">@innost <br>我有两个问题请教一下:<br>1、
在android binder下的server端通过ProcessState、defaultServiceManager获取service 
manager的代理接口。在client端中，也是通过defaultServiceManager获取到service 
manager的代理接口。那我想问的是，在client端中调用defaultServiceManager时，是否新建了ProcessState对
象，如果新建了，在client端也要打开binder设备？<br>2、在binder中，为了能够使得client端能够获取server端通过
notify发送的消息，在client端是作为本地端，而server端则作为"client"端。在server中是有IPCThreadState
进行轮询监测binder驱动，那么在client端中怎么知道server端发送notify消息了？ <br>谢谢！</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2606075,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2606075,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2606076" class="layer">#108楼</a><a name="2606076" id="comment_anchor_2606076"></a>  <span class="comment_date">2013-01-23 20:09</span> <a id="a_comment_author_2606076" href="http://home.cnblogs.com/u/491556/" target="_blank">飞天红猪侠</a> <a href="http://space.cnblogs.com/msg/send/%e9%a3%9e%e5%a4%a9%e7%ba%a2%e7%8c%aa%e4%be%a0" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2606076" class="blog_comment_body"><a href="#2582742" title="查看所回复的评论">@</a>innost</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2606076,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2606076,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2606227" class="layer">#109楼</a><a name="2606227" id="comment_anchor_2606227"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2013-01-24 07:18</span> <a id="a_comment_author_2606227" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2606227" class="blog_comment_body"><a href="#2606075" title="查看所回复的评论">@</a>飞天红猪侠<br>小伙子，你问的问题倒是挺头头是道。但是感觉对binder本质还是不清楚。麻烦从网上下深入理解卷1第六章电子版，结合代码仔细看看。你这个问题，不给写上一两页，无法说清楚。呵呵 加油。已经有一点入门了.</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2606227,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2606227,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2606481" class="layer">#110楼</a><a name="2606481" id="comment_anchor_2606481"></a>  <span class="comment_date">2013-01-24 11:09</span> <a id="a_comment_author_2606481" href="http://home.cnblogs.com/u/491556/" target="_blank">飞天红猪侠</a> <a href="http://space.cnblogs.com/msg/send/%e9%a3%9e%e5%a4%a9%e7%ba%a2%e7%8c%aa%e4%be%a0" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2606481" class="blog_comment_body"><a href="#2606227" title="查看所回复的评论">@</a>innost<br><fieldset class="comment_quote"><legend><a href="#2606227" title="查看引用原文">引用</a></legend>@飞天红猪侠<br>小伙子，你问的问题倒是挺头头是道。但是感觉对binder本质还是不清楚。麻烦从网上下深入理解卷1第六章电子版，结合代码仔细看看。你这个问题，不给写上一两页，无法说清楚。呵呵 加油。已经有一点入门了.</fieldset><br>代码我已经研究了有一段时间了，自己也写了binder程序，但是感觉就是在这两个问题上卡住了，不知道能不能大概指出我在这里有哪些问题，好有一个方向。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2606481,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2606481,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2606573" class="layer">#111楼</a><a name="2606573" id="comment_anchor_2606573"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2013-01-24 12:22</span> <a id="a_comment_author_2606573" href="http://www.cnblogs.com/innost/" target="_blank">innost</a> <a href="http://space.cnblogs.com/msg/send/innost" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2606573" class="blog_comment_body"><a href="#2606481" title="查看所回复的评论">@</a>飞天红猪侠<br>看
电子版书了么？注意代码外的文字了么？如果仔细看了，怎么会连client端是否打开binder设备都不清楚呢？要参与binder通信，是不是都得打
开binder设备？建议你再回头重新整理下思路。现在感觉你看了足够多代码，资料，吸收了足够多的知识，但就是没有串起来。这一关你必须自己过，这样你
才能成长。呵呵。我也经历过类似的痛苦。下一次，你带着问题和你的初步答案来求证。大胆假设，小心求证，送给你 呵呵 加油。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2606573,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2606573,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="#2606901" class="layer">#112楼</a><a name="2606901" id="comment_anchor_2606901"></a><span id="comment-maxId" style="display:none;">2606901</span><span id="comment-maxDate" style="display:none;">2013/1/24 16:49:15</span>  <span class="comment_date">2013-01-24 16:49</span> <a id="a_comment_author_2606901" href="http://home.cnblogs.com/u/491556/" target="_blank">飞天红猪侠</a> <a href="http://space.cnblogs.com/msg/send/%e9%a3%9e%e5%a4%a9%e7%ba%a2%e7%8c%aa%e4%be%a0" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2606901" class="blog_comment_body"><a href="#2606573" title="查看所回复的评论">@</a>innost<br>谢谢，那我小心求证去了。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2606901,'Digg',this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2606901,'Bury',this)">反对(0)</a></div>
			</div>
		</div>
	<div id="comments_pager_bottom"><div class="pager"><a href="javascript:void(0);" onclick="commentManager.loadPagedComments(false,2,50);return false;">&lt; Prev</a><a href="javascript:void(0);" onclick="commentManager.loadPagedComments(false,1,50);return false;">1</a><a href="javascript:void(0);" onclick="commentManager.loadPagedComments(false,2,50);return false;">2</a><span class="current">3</span></div></div></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.loadComments();</script>
<div id="comment_form" class="commentform">
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" id="lnk_RefreshComments" onclick="return RefreshCommentList();">刷新评论</a><a href="#" onclick="return RefreshPage();">刷新页面</a><a href="#top">返回顶部</a></div>
<div id="comment_form_container"><div class="login_tips">注册用户登录后才能发表评论，请 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return login('commentform');">登录</a> 或 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return register();">注册</a>，<a href="http://www.cnblogs.com/">访问</a>网站首页。</div></div>

<script type="text/javascript">
    if (typeof commentManager === 'undefined') {
        commentManager = new blogCommentManager();
    }
    commentManager.loadCommentForm();   
</script>

<div class="ad_text_commentbox" id="ad_text_under_commentbox"><a href="http://zt.cnblogs.com/ie10/" target="_blank"><b>IE10：全面支持HTML5，让你创造更多</b></a><br><a href="http://job.cnblogs.com/" target="_blank"><b>找优秀程序员，就在博客园</b></a><br></div>
<div id="site_nav_under"><a href="http://www.cnblogs.com/" target="_blank" title="程序员的网上家园">博客园首页</a><a href="http://q.cnblogs.com/" target="_blank" title="程序员问答社区">博问</a><a href="http://news.cnblogs.com/" target="_blank" title="IT新闻">新闻</a><a href="http://home.cnblogs.com/ing/" target="_blank">闪存</a><a href="http://job.cnblogs.com/" target="_blank">程序员招聘</a><a href="http://kb.cnblogs.com/" target="_blank">知识库</a></div>
<div id="ad_under_post_holder">
<div id="google_ad_c1" class="c_ad_block">
    <!-- cnblogs_blogpost_C1_sitehome -->
    <div id="div-gpt-ad-1346480159711-0" style="width: 300px; height: 250px;">
    
    <iframe style="border: 0pt none;" marginheight="0" marginwidth="0" name="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0" id="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0" frameborder="0" height="250" scrolling="no" width="300"></iframe><iframe style="border: 0pt none; visibility: hidden; display: none;" marginheight="0" marginwidth="0" name="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0__hidden__" id="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0__hidden__" frameborder="0" height="0" scrolling="no" width="0"></iframe></div>
</div>
<div id="blog_news_kb"><div class="itnews c_ad_block"><b>最新IT新闻</b>:<br> ·  <a href="http://news.cnblogs.com/n/170460/" target="_blank">Square COO 因忍受不了性骚扰指控而辞职</a><br> ·  <a href="http://news.cnblogs.com/n/170459/" target="_blank">史上最糟糕的八大科技活动主题演讲</a><br> ·  <a href="http://news.cnblogs.com/n/170458/" target="_blank">百度推广后台被爆禁止用360浏览器登录</a><br> ·  <a href="http://news.cnblogs.com/n/170457/" target="_blank">央视专访比尔·盖茨：你幸福吗</a><br> ·  <a href="http://news.cnblogs.com/n/170456/" target="_blank">乔布斯传记主角：演帮主压力山大</a><br>» <a href="http://news.cnblogs.com/" title="IT新闻" target="_blank">更多新闻...</a></div><div class="itnews c_ad_block" id="kb_block"><b>最新知识库文章</b>:<br><div id="kb_recent"> ·  <a href="http://kb.cnblogs.com/page/170440/" target="_blank">Couchbase 与 Membase, CouchDB 的关系</a><br> ·  <a href="http://kb.cnblogs.com/page/170382/" target="_blank">360的困兽之斗——重新探讨奇虎商业模式</a><br> ·  <a href="http://kb.cnblogs.com/page/170370/" target="_blank">Map Reduce – the Free Lunch is not over?</a><br> ·  <a href="http://kb.cnblogs.com/page/170288/" target="_blank">从游戏设计机制以及玩家心理特征谈互联网产品设计理念</a><br> ·  <a href="http://kb.cnblogs.com/page/169820/" target="_blank">浏览器的重绘与重排</a><br></div>» <a href="http://kb.cnblogs.com/" target="_blank">更多知识库文章...</a></div></div>
<div id="google_ad_c2" class="c_ad_block">
    <!-- cnblogs_blogpost_C2_sitehome -->
    <div id="div-gpt-ad-1346479110744-1" style="width: 468px; height: 60px;">
    
    <iframe style="border: 0pt none;" marginheight="0" marginwidth="0" name="google_ads_iframe_/1090369/cnblogs_blogpost_C2_sitehome_0" id="google_ads_iframe_/1090369/cnblogs_blogpost_C2_sitehome_0" frameborder="0" height="60" scrolling="no" width="468"></iframe></div>
</div></div>
<div id="HistoryToday" class="c_ad_block"></div>
</div>





	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
	<div id="blog-news"><div id="profile_block">昵称：<a href="http://home.cnblogs.com/u/innost/">innost</a><br>园龄：<a href="http://home.cnblogs.com/u/innost/" title="入园时间：2011-01-09">2年</a><br>粉丝：<a href="http://home.cnblogs.com/u/innost/followers/">147</a><br>关注：<a href="http://home.cnblogs.com/u/innost/followees/">5</a><div id="p_b_follow"><a href="javascript:void(0);" onclick="cnblogs.UserManager.FollowBlogger('de1c1283-921b-e011-ac81-842b2b196315')">+加关注</a></div></div></div>
</div>

			<div id="calendar"><div id="blog-calendar" style="displya:none"><table id="blogCalendar" class="Cal" title="Calendar" cellpadding="0" cellspacing="0">
	<tbody><tr><td colspan="7"><table class="CalTitle" cellspacing="0">
		<tbody><tr><td class="CalNextPrev"><a href="javascript:void(0);" onclick="loadBlogCalendar('2010/12/01');return false;">&lt;</a></td><td align="center">2011年1月</td><td class="CalNextPrev" align="right"><a href="javascript:void(0);" onclick="loadBlogCalendar('2011/02/01');return false;">&gt;</a></td></tr>
	</tbody></table></td></tr><tr><th class="CalDayHeader" abbr="日" scope="col" align="center">日</th><th class="CalDayHeader" abbr="一" scope="col" align="center">一</th><th class="CalDayHeader" abbr="二" scope="col" align="center">二</th><th class="CalDayHeader" abbr="三" scope="col" align="center">三</th><th class="CalDayHeader" abbr="四" scope="col" align="center">四</th><th class="CalDayHeader" abbr="五" scope="col" align="center">五</th><th class="CalDayHeader" abbr="六" scope="col" align="center">六</th></tr><tr><td class="CalOtherMonthDay" align="center">26</td><td class="CalOtherMonthDay" align="center">27</td><td class="CalOtherMonthDay" align="center">28</td><td class="CalOtherMonthDay" align="center">29</td><td class="CalOtherMonthDay" align="center">30</td><td class="CalOtherMonthDay" align="center">31</td><td class="CalWeekendDay" align="center">1</td></tr><tr><td class="CalWeekendDay" align="center">2</td><td align="center">3</td><td align="center">4</td><td align="center">5</td><td align="center">6</td><td align="center">7</td><td class="CalWeekendDay" align="center">8</td></tr><tr><td class="CalWeekendDay" align="center"><a href="http://www.cnblogs.com/innost/archive/2011/01/09.html"><u>9</u></a></td><td align="center">10</td><td align="center">11</td><td align="center">12</td><td align="center">13</td><td align="center">14</td><td class="CalWeekendDay" align="center"><a href="http://www.cnblogs.com/innost/archive/2011/01/15.html"><u>15</u></a></td></tr><tr><td class="CalWeekendDay" align="center">16</td><td align="center"><a href="http://www.cnblogs.com/innost/archive/2011/01/17.html"><u>17</u></a></td><td align="center">18</td><td align="center">19</td><td align="center">20</td><td align="center">21</td><td class="CalWeekendDay" align="center"><a href="http://www.cnblogs.com/innost/archive/2011/01/22.html"><u>22</u></a></td></tr><tr><td class="CalWeekendDay" align="center">23</td><td align="center">24</td><td align="center">25</td><td align="center"><a href="http://www.cnblogs.com/innost/archive/2011/01/26.html"><u>26</u></a></td><td align="center">27</td><td align="center">28</td><td class="CalWeekendDay" align="center">29</td></tr><tr><td class="CalWeekendDay" align="center">30</td><td align="center">31</td><td class="CalOtherMonthDay" align="center">1</td><td class="CalOtherMonthDay" align="center">2</td><td class="CalOtherMonthDay" align="center">3</td><td class="CalOtherMonthDay" align="center">4</td><td class="CalOtherMonthDay" align="center">5</td></tr>
</tbody></table></div></div>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn">

<div class="mySearch">
<h3 class="catListTitle">搜索</h3>
<div id="widget_my_zzk" class="div_my_zzk"><input id="q" onkeydown="return zzk_go_enter(event);" class="input_my_zzk" type="text">&nbsp;<input onclick="zzk_go()" value="找找看" id="btnZzk" class="btn_my_zzk" type="button"></div>
<div id="widget_my_google" class="div_my_zzk"><input name="google_q" id="google_q" onkeydown="return google_go_enter(event)" class="input_my_zzk" type="text">&nbsp;<input onclick="google_go()" value="谷歌搜索" class="btn_my_zzk" type="button"></div>
</div>


<div class="catListLink">
<h3 class="catListTitle">常用链接</h3>
<ul>

		<li><a id="ctl01_rptMainLinks_lnkLinkItem_0" href="http://www.cnblogs.com/innost/MyPosts.html">我的随笔</a></li>
	
		<li><a id="ctl01_rptMainLinks_lnkLinkItem_1" href="http://www.cnblogs.com/innost/MyComments.html">我的评论</a></li>
	
		<li><a id="ctl01_rptMainLinks_lnkLinkItem_2" title="我发表过评论的随笔" href="http://www.cnblogs.com/innost/OtherPosts.html">我的参与</a></li>
	
		<li><a id="ctl01_rptMainLinks_lnkLinkItem_3" href="http://www.cnblogs.com/innost/RecentComments.html">最新评论</a></li>
	
		<li><a id="ctl01_rptMainLinks_lnkLinkItem_4" href="http://www.cnblogs.com/innost/tag/">我的标签</a></li>
	
</ul>
<div id="itemListLin_con" style="display:none;">
<ul>

</ul>
</div>
</div>
<div class="catListTag">
<h3 class="catListTitle">我的标签</h3>
<ul>
<li><a href="http://www.cnblogs.com/innost/tag/android/">android</a>(1)</li><li><a href="http://www.cnblogs.com/innost/tag/%E5%AE%9A%E5%88%B6rom/">定制rom</a>(1)</li>
</ul>
</div>
<div class="catListPostCategory">
<h3 class="catListTitle">随笔分类</h3>

<ul>

<li><a id="ctl03_CatList_LinkList_0_Link_0" href="http://www.cnblogs.com/innost/category/279110.html">Android 深入浅出(20)</a> </li>

</ul>

</div>

<div class="catListPostArchive">
<h3 class="catListTitle">随笔档案</h3>

<ul>

<li><a id="ctl03_CatList_LinkList_1_Link_0" href="http://www.cnblogs.com/innost/archive/2012/10.html">2012年10月 (1)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_1" href="http://www.cnblogs.com/innost/archive/2012/09.html">2012年9月 (1)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_2" href="http://www.cnblogs.com/innost/archive/2012/08.html">2012年8月 (4)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_3" href="http://www.cnblogs.com/innost/archive/2012/07.html">2012年7月 (6)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_4" href="http://www.cnblogs.com/innost/archive/2012/06.html">2012年6月 (3)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_5" href="http://www.cnblogs.com/innost/archive/2012/05.html">2012年5月 (1)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_6" href="http://www.cnblogs.com/innost/archive/2012/04.html">2012年4月 (2)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_7" href="http://www.cnblogs.com/innost/archive/2012/03.html">2012年3月 (1)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_8" href="http://www.cnblogs.com/innost/archive/2012/01.html">2012年1月 (1)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_9" href="http://www.cnblogs.com/innost/archive/2011/12.html">2011年12月 (5)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_10" href="http://www.cnblogs.com/innost/archive/2011/11.html">2011年11月 (8)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_11" href="http://www.cnblogs.com/innost/archive/2011/10.html">2011年10月 (4)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_12" href="http://www.cnblogs.com/innost/archive/2011/09.html">2011年9月 (2)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_13" href="http://www.cnblogs.com/innost/archive/2011/08.html">2011年8月 (1)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_14" href="http://www.cnblogs.com/innost/archive/2011/07.html">2011年7月 (1)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_15" href="http://www.cnblogs.com/innost/archive/2011/02.html">2011年2月 (1)</a> </li>

<li><a id="ctl03_CatList_LinkList_1_Link_16" href="http://www.cnblogs.com/innost/archive/2011/01.html">2011年1月 (6)</a> </li>

</ul>

</div>

<div class="catListArticleCategory">
<h3 class="catListTitle">文章分类</h3>

<ul>

<li><a id="ctl03_CatList_LinkList_2_Link_0" href="http://www.cnblogs.com/innost/category/279167.html">Android深入浅出(1)</a> </li>

</ul>

</div>


<div class="catListComment">
<h3 class="catListTitle">最新评论</h3>
	<div id="RecentCommentsBlock"><ul>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html#2606901">1. Re:Android深入浅出之Binder机制</a></li>
    <li class="recent_comment_body"><a href="#2606573" title="查看所回复的评论">@</a>innost<br>谢谢，那我小心求证去了。</li>
    <li class="recent_comment_author">--飞天红猪侠</li>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html#2606573">2. Re:Android深入浅出之Binder机制</a></li>
    <li class="recent_comment_body">@飞天红猪侠看电子版书了么？注意代码外的文字了么？如果仔细看了，怎么会连
client端是否打开binder设备都不清楚呢？要参与binder通信，是不是都得打开binder设备？建议你再回头重新整理下思路。现在感觉你
看了足够多代码，资料，吸收了足够多的知识，但就是没有串起来。这一关你必须自己过，这样你才能成长。呵呵。我也经历过类似的痛苦。下一次，你带着问题和
你的初步答案来求证。大胆假设，小心求证，...</li>
    <li class="recent_comment_author">--innost</li>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html#2606481">3. Re:Android深入浅出之Binder机制</a></li>
    <li class="recent_comment_body">@innost引用@飞天红猪侠小伙子，你问的问题倒是挺头头是道。但是感觉
对binder本质还是不清楚。麻烦从网上下深入理解卷1第六章电子版，结合代码仔细看看。你这个问题，不给写上一两页，无法说清楚。呵呵 
加油。已经有一点入门了.代码我已经研究了有一段时间了，自己也写了binder程序，但是感觉就是在这两个问题上卡住了，不知道能不能大概指出我在这里
有哪些问题，好有一个方向。</li>
    <li class="recent_comment_author">--飞天红猪侠</li>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html#2606227">4. Re:Android深入浅出之Binder机制</a></li>
    <li class="recent_comment_body"><a href="#2606075" title="查看所回复的评论">@</a>飞天红猪侠<br>小伙子，你问的问题倒是挺头头是道。但是感觉对binder本质还是不清楚。麻烦从网上下深入理解卷1第六章电子版，结合代码仔细看看。你这个问题，不给写上一两页，无法说清楚。呵呵 加油。已经有一点入门了.</li>
    <li class="recent_comment_author">--innost</li>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html#2606076">5. Re:Android深入浅出之Binder机制</a></li>
    <li class="recent_comment_body"><a href="#2582742" title="查看所回复的评论">@</a>innost</li>
    <li class="recent_comment_author">--飞天红猪侠</li>
</ul>
</div>
</div>

<div class="catListView">
<h3 class="catListTitle">阅读排行榜</h3>
	<div id="TopViewPostsBlock"><ul><li><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html">1. Android深入浅出之Binder机制(64910)</a></li><li><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931457.html">2. Android深入浅出之Audio 第一部分 AudioTrack分析(28165)</a></li><li><a href="http://www.cnblogs.com/innost/archive/2011/01/15/1936425.html">3. Android深入浅出之Audio 第二部分 AudioFlinger分析(15462)</a></li><li><a href="http://www.cnblogs.com/innost/archive/2011/01/26/1945769.html">4. Android深入浅出之Zygote[1](12455)</a></li><li><a href="http://www.cnblogs.com/innost/archive/2011/01/22/1942149.html">5. Android深入浅出之Audio第三部分Audio Policy[1](10575)</a></li></ul></div>
</div>

<div class="catListFeedback">
<h3 class="catListTitle">评论排行榜</h3>
	<div id="TopFeedbackPostsBlock"><ul><li><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html">1. Android深入浅出之Binder机制(112)</a></li><li><a href="http://www.cnblogs.com/innost/archive/2012/03/05/2380274.html">2. 随笔之Android不吐不快(42)</a></li><li><a href="http://www.cnblogs.com/innost/archive/2011/12/01/2270218.html">3. 随笔之由Kindle fire想到的(24)</a></li><li><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931457.html">4. Android深入浅出之Audio 第一部分 AudioTrack分析(16)</a></li><li><a href="http://www.cnblogs.com/innost/archive/2011/10/18/2216871.html">5. Android源码下载以及编译自己的ROM(14)</a></li></ul></div>
</div>

<div class="catListView">
<h3 class="catListTitle">推荐排行榜</h3>
<div id="TopDiggPostsBlock"><ul><li><a href="http://www.cnblogs.com/innost/archive/2012/03/05/2380274.html">1. 随笔之Android不吐不快(14)</a></li><li><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html">2. Android深入浅出之Binder机制(9)</a></li><li><a href="http://www.cnblogs.com/innost/archive/2011/01/09/1931457.html">3. Android深入浅出之Audio 第一部分 AudioTrack分析(4)</a></li><li><a href="http://www.cnblogs.com/innost/archive/2012/09/08/2677045.html">4. Android BSP成长计划随笔之虚拟设备搭建和input系统(4)</a></li><li><a href="http://www.cnblogs.com/innost/archive/2012/06/01/2531048.html">5. android rom移植知识普及(4)</a></li></ul></div>
</div></div>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright ©2013 innost
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->
<script type="text/javascript" src="1931456_files/google-analytics.js"></script>


</body></html>